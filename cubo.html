<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rubik Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cube-solver@2.4.1/dist/bundle.min.js"></script>
    
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            touch-action: none;
        }
        
        .camera-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50vh;
            background: #111;
            overflow: hidden;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .camera-guide {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .grid-overlay {
            width: 200px;
            height: 200px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
            opacity: 0.6;
        }
        
        .grid-cell {
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.05);
        }
        
        .grid-cell.center {
            border: 2px solid #22c55e;
            background: rgba(34,197,94,0.2);
        }
        
        .shutter-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            cursor: pointer;
        }
        
        .shutter-btn::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: 50%;
            background: white;
            transition: transform 0.1s;
        }
        
        .shutter-btn:active::after {
            transform: scale(0.9);
        }
        
        .edit-view {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50vh;
            background: #1a1a1a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }
        
        .face-cube {
            width: 180px;
            height: 180px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            padding: 8px;
            background: #2a2a2a;
            border-radius: 12px;
        }
        
        .face-cell {
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s;
            position: relative;
        }
        
        .face-cell:active {
            transform: scale(0.95);
        }
        
        .face-cell.selected::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 3px solid #3b82f6;
            border-radius: 12px;
        }
        
        .color-palette {
            display: flex;
            gap: 12px;
            padding: 0 20px;
        }
        
        .color-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .color-btn.active {
            border-color: white;
            transform: scale(1.15);
            box-shadow: 0 0 20px currentColor;
        }
        
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 0 20px;
        }
        
        .action-btn {
            color: white;
            font-size: 16px;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            cursor: pointer;
        }
        
        .action-btn.primary {
            background: #22c55e;
        }
        
        .hidden { display: none !important; }
        
        .step-indicator {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .step-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
        }
        
        .step-dot.active {
            background: #22c55e;
            width: 24px;
            border-radius: 4px;
        }
        
        .step-dot.done {
            background: #22c55e;
        }
        
        #file-input {
            display: none;
        }
        
        .upload-fab {
            position: absolute;
            bottom: 35px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .edit-hint {
            position: absolute;
            top: 20px;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
        }
    </style>
</head>
<body>

    <!-- C√¢mera (Top Half) -->
    <div class="camera-view">
        <video id="video" autoplay playsinline muted></video>
        
        <div class="step-indicator" id="step-indicator">
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
        </div>
        
        <div class="camera-guide">
            <div class="grid-overlay" id="grid-overlay">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell center"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
        </div>
        
        <button class="shutter-btn" onclick="capture()"></button>
        <button class="upload-fab" onclick="document.getElementById('file-input').click()">üìÅ</button>
        <input type="file" id="file-input" accept="image/*" capture="environment">
    </div>

    <!-- Editor (Bottom Half) -->
    <div class="edit-view">
        <div class="edit-hint">Toque nas cores para editar</div>
        
        <div class="face-cube" id="face-cube">
            <!-- Gerado via JS -->
        </div>
        
        <div class="color-palette" id="color-palette">
            <!-- Gerado via JS -->
        </div>
    </div>

    <!-- Barra de A√ß√£o -->
    <div class="bottom-bar">
        <button class="action-btn" onclick="reset()">‚Ü∫</button>
        <button class="action-btn primary" onclick="confirm()">‚úì Confirmar</button>
    </div>

    <script>
        const COLORS = [
            { code: 'U', hex: '#FFFFFF', name: 'Branco' },
            { code: 'R', hex: '#EF4444', name: 'Vermelho' },
            { code: 'F', hex: '#22C55E', name: 'Verde' },
            { code: 'D', hex: '#EAB308', name: 'Amarelo' },
            { code: 'L', hex: '#F97316', name: 'Laranja' },
            { code: 'B', hex: '#3B82F6', name: 'Azul' }
        ];
        
        const STEPS = ['U', 'R', 'F', 'D', 'L', 'B'];
        let currentStep = 0;
        let currentFace = Array(9).fill('U');
        let selectedCell = 4; // Centro selecionado por padr√£o
        
        // Inicializa√ß√£o
        window.onload = () => {
            initCamera();
            initEditor();
            updateStepIndicator();
        };
        
        // C√¢mera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                document.getElementById('video').srcObject = stream;
                document.getElementById('video').style.display = 'block';
            } catch (e) {
                console.log('C√¢mera n√£o dispon√≠vel, usando upload');
            }
        }
        
        // Editor
        function initEditor() {
            // Criar grid 3x3
            const cube = document.getElementById('face-cube');
            cube.innerHTML = '';
            for (let i = 0; i < 9; i++) {
                const cell = document.createElement('div');
                cell.className = 'face-cell';
                cell.style.background = COLORS[0].hex;
                cell.onclick = () => selectCell(i);
                cube.appendChild(cell);
            }
            
            // Criar paleta
            const palette = document.getElementById('color-palette');
            palette.innerHTML = '';
            COLORS.forEach((c, i) => {
                const btn = document.createElement('div');
                btn.className = 'color-btn' + (i === 0 ? ' active' : '');
                btn.style.background = c.hex;
                btn.onclick = () => setColor(c.code);
                palette.appendChild(btn);
            });
            
            selectCell(4);
        }
        
        function selectCell(index) {
            selectedCell = index;
            document.querySelectorAll('.face-cell').forEach((c, i) => {
                c.classList.toggle('selected', i === index);
            });
        }
        
        function setColor(code) {
            currentFace[selectedCell] = code;
            const color = COLORS.find(c => c.code === code);
            document.querySelectorAll('.face-cell')[selectedCell].style.background = color.hex;
            
            // Auto-selecionar pr√≥xima c√©lula (esquerda para direita, cima para baixo)
            if (selectedCell < 8) {
                selectCell(selectedCell + 1);
            }
            
            // Atualizar paleta ativa
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.style.background === color.hex) {
                    btn.classList.add('active');
                }
            });
        }
        
        // Captura de foto
        function capture() {
            const video = document.getElementById('video');
            if (!video.srcObject) {
                document.getElementById('file-input').click();
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Extrair cores do centro
            const colors = extractFromCanvas(ctx, canvas.width, canvas.height);
            applyColors(colors);
        }
        
        // Upload de arquivo
        document.getElementById('file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const colors = extractFromCanvas(ctx, canvas.width, canvas.height);
                applyColors(colors);
            };
            img.src = URL.createObjectURL(file);
        });
        
        function extractFromCanvas(ctx, w, h) {
            const cx = w / 2;
            const cy = h / 2;
            const size = Math.min(w, h) * 0.4;
            const cell = size / 3;
            
            const colors = [];
            for (let r = 0; r < 3; r++) {
                for (let c = 0; c < 3; c++) {
                    const x = cx - size/2 + c * cell + cell/2;
                    const y = cy - size/2 + r * cell + cell/2;
                    const p = getPixel(ctx, x, y);
                    colors.push(rgbToCode(p.r, p.g, p.b));
                }
            }
            return colors;
        }
        
        function getPixel(ctx, x, y) {
            const d = ctx.getImageData(x-10, y-10, 20, 20).data;
            let r=0, g=0, b=0, n=0;
            for (let i=0; i<d.length; i+=4) {
                r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++;
            }
            return {r:r/n, g:g/n, b:b/n};
        }
        
        function rgbToCode(r, g, b) {
            const hsv = rgbToHsv(r,g,b);
            const [h,s,v] = hsv;
            
            if (v>0.8 && s<0.25) return 'U';
            if (h>50 && h<80 && s>0.4) return 'D';
            if (h>15 && h<45 && s>0.5) return 'L';
            if ((h<15 || h>340) && s>0.4) return 'R';
            if (h>90 && h<150 && s>0.3) return 'F';
            if (h>200 && h<260 && s>0.4) return 'B';
            return 'U';
        }
        
        function rgbToHsv(r,g,b) {
            r/=255; g/=255; b/=255;
            const max=Math.max(r,g,b), min=Math.min(r,g,b);
            let h=0,s=0,v=max;
            const d=max-min;
            s=max===0?0:d/max;
            if(max!==min) {
                switch(max) {
                    case r: h=(g-b)/d+(g<b?6:0); break;
                    case g: h=(b-r)/d+2; break;
                    case b: h=(r-g)/d+4; break;
                }
                h/=6;
            }
            return [h*360,s,v];
        }
        
        function applyColors(colors) {
            currentFace = colors;
            const cells = document.querySelectorAll('.face-cell');
            colors.forEach((code, i) => {
                const c = COLORS.find(x => x.code === code);
                cells[i].style.background = c.hex;
            });
        }
        
        // A√ß√µes
        function confirm() {
            // Salvar face atual
            console.log('Face', STEPS[currentStep], ':', currentFace);
            
            // Pr√≥ximo passo
            currentStep++;
            if (currentStep < 6) {
                updateStepIndicator();
                // Reset para pr√≥xima face (centro j√° vem preenchido)
                const nextCenter = STEPS[currentStep];
                currentFace = Array(9).fill(nextCenter);
                applyColors(currentFace);
                selectCell(0); // Come√ßar pelo canto
            } else {
                alert('Todas as faces capturadas! Pronto para resolver.');
            }
        }
        
        function reset() {
            currentFace = Array(9).fill(STEPS[currentStep]);
            applyColors(currentFace);
            selectCell(4);
        }
        
        function updateStepIndicator() {
            const dots = document.querySelectorAll('.step-dot');
            dots.forEach((d, i) => {
                d.classList.remove('active', 'done');
                if (i < currentStep) d.classList.add('done');
                else if (i === currentStep) d.classList.add('active');
            });
        }
    </script>
</body>
</html>
