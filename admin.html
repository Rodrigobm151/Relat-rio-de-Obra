<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VER 1.9</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --azul-vale: #3CB5E5;
            --azul-escuro: #0096d2;
            --verde-vale: #007E79;
            --cinza-texto: #555555;
            --branco: #FFFFFF;
            --cinza-medio: #747678;
            --cinza-claro: #BCBEC0;
            --cinza-mais-claro: #E6E7E8;
            --laranja: #ff9800;
            --vermelho: #e74c3c;
            --fundo: #f5f7fa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--fundo); color: var(--cinza-texto); line-height: 1.6; }
        
        .header { background: var(--azul-vale); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.3rem; font-weight: 600; font-style: italic; }
        .btn-sair { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; transition: all 0.3s; }
        .btn-sair:hover { background: rgba(255,255,255,0.3); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid var(--cinza-mais-claro); overflow-x: auto; }
        .tab-btn { background: none; border: none; padding: 1rem 1.5rem; cursor: pointer; font-size: 0.95rem; color: var(--cinza-medio); border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s; white-space: nowrap; }
        .tab-btn.active { color: var(--azul-vale); border-bottom-color: var(--azul-vale); font-weight: 600; }
        .tab-btn:hover { color: var(--azul-vale); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .card { background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card-title { color: var(--azul-vale); font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; font-style: italic; display: flex; align-items: center; gap: 0.5rem; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
        @media (max-width: 768px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; font-style: italic; color: var(--cinza-texto); }
        .form-input, .form-select { width: 100%; padding: 0.8rem; border: 2px solid var(--cinza-mais-claro); border-radius: 8px; font-size: 1rem; transition: all 0.3s; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--azul-vale); }
        
        .btn { background: var(--azul-vale); color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn:hover { background: var(--azul-escuro); transform: translateY(-1px); }
        .btn-success { background: var(--verde-vale); }
        .btn-success:hover { background: #006b66; }
        .btn-danger { background: var(--vermelho); }
        .btn-danger:hover { background: #c0392b; }
        .btn-warning { background: var(--laranja); }
        .btn-secondary { background: var(--cinza-mais-claro); color: var(--cinza-texto); }
        .btn-secondary:hover { background: var(--cinza-claro); }
        
        .obra-item { background: white; border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; cursor: pointer; }
        .obra-item:hover { transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .obra-info h3 { font-size: 1.1rem; color: var(--cinza-texto); margin-bottom: 0.3rem; }
        .obra-info p { font-size: 0.85rem; color: var(--cinza-medio); }
        .obra-actions { display: flex; gap: 0.5rem; }
        .btn-icon { width: 40px; height: 40px; border-radius: 8px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.3s; }
        .btn-icon:hover { transform: scale(1.1); }
        
        .fiscal-item { background: white; border-radius: 12px; padding: 1rem 1.2rem; margin-bottom: 0.8rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .fiscal-info { display: flex; align-items: center; gap: 1rem; }
        .fiscal-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--azul-vale); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: 600; }
        .fiscal-status { display: inline-block; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-top: 0.2rem; }
        .fiscal-status.ativo { background: #e8f5e9; color: var(--verde-vale); }
        .fiscal-status.inativo { background: #ffebee; color: var(--vermelho); }
        
        .equip-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .equip-info { background: var(--fundo); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
        .equip-info p { margin: 0.3rem 0; font-size: 0.9rem; color: var(--cinza-medio); }
        .equip-info strong { color: var(--cinza-texto); }
        
        .dica-box { background: #e3f2fd; border-left: 4px solid var(--azul-vale); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; color: var(--cinza-texto); }
        .dica-box i { color: var(--azul-vale); margin-right: 0.5rem; }
        
        #dropZone { border: 2px dashed var(--cinza-claro); border-radius: 12px; padding: 2rem; text-align: center; background: white; transition: all 0.3s; }
        #dropZone.dragover { border-color: var(--azul-vale); background: #e3f2fd; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { padding: 0.8rem; text-align: left; border-bottom: 1px solid var(--cinza-mais-claro); }
        th { background: var(--fundo); font-weight: 600; color: var(--cinza-texto); }
        tr:hover { background: rgba(60, 181, 229, 0.05); }
        
        .rdc-item { background: white; border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; }
        .rdc-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .rdc-info h3 { font-size: 1.1rem; color: var(--cinza-texto); margin-bottom: 0.3rem; }
        .rdc-info p { font-size: 0.85rem; color: var(--cinza-medio); }
        
        .status-badge { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-enviado { background: #e8f5e9; color: var(--verde-vale); }
        .status-rascunho { background: #fff3e0; color: var(--laranja); }
        .status-pendente { background: #ffebee; color: var(--vermelho); }
        
        .export-card { background: linear-gradient(135deg, var(--verde-vale) 0%, #006b66 100%); color: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
        .export-card h3 { margin-bottom: 1rem; font-style: italic; }
        .export-card .form-select { background: white; color: var(--cinza-texto); }
        
        .loading { text-align: center; padding: 3rem; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--cinza-mais-claro); border-top-color: var(--azul-vale); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 3rem; color: var(--cinza-medio); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; color: var(--cinza-claro); }
        
        .toast { position: fixed; top: 80px; right: 20px; background: var(--cinza-texto); color: white; padding: 1rem 1.5rem; border-radius: 8px; opacity: 0; transition: all 0.3s; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; }
        .toast.success { background: var(--verde-vale); }
        .toast.error { background: var(--vermelho); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-title { color: var(--azul-vale); font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; font-style: italic; }
        .modal-footer { display: flex; gap: 1rem; margin-top: 1.5rem; }
        .modal-footer .btn { flex: 1; justify-content: center; }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-cog"></i> Painel Administrativo</h1>
            <button class="btn-sair" onclick="sair()"><i class="fas fa-sign-out-alt"></i> Sair</button>
        </div>
    </header>

    <div class="container">
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('obras', this)"><i class="fas fa-building"></i> Obras e Equipamentos</button>
            <button class="tab-btn" onclick="switchTab('fiscais', this)"><i class="fas fa-users"></i> Fiscais</button>
            <button class="tab-btn" onclick="switchTab('rdcs', this)"><i class="fas fa-clipboard-list"></i> RDCs</button>
        </div>

        <!-- ABA OBRAS E EQUIPAMENTOS -->
        <div class="tab-content active" id="tab-obras">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-plus-circle"></i> Nova Obra</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">Nome da obra</label>
                        <input type="text" class="form-input" id="novaObraNome" placeholder="Ex: Mineração Sul">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de início</label>
                        <input type="date" class="form-input" id="novaObraData">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-input" id="novaObraLocal" placeholder="Ex: Carajás - PA">
                    </div>
                </div>
                <button class="btn btn-success" onclick="criarObra()"><i class="fas fa-save"></i> Criar Obra</button>
            </div>

            <div id="obrasList">
                <div class="loading"><div class="spinner"></div><p>Carregando obras...</p></div>
            </div>

            <div id="equipamentosEditor" style="display: none;">
                <div class="card">
                    <div class="equip-header">
                        <div>
                            <h3 class="card-title"><i class="fas fa-file-excel"></i> Importar Equipamentos</h3>
                        </div>
                    </div>

                    <div class="equip-info">
                        <p><strong>Obra:</strong> <span id="equipObraNome">-</span></p>
                    </div>

                    <div class="dica-box">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Como importar:</strong> Baixe o modelo, preencha com os meses no formato <strong>Jan/2026, Fev/2026...</strong> e faça o upload. O sistema salvará todos os meses automaticamente.
                    </div>

                    <div style="background: var(--fundo); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--cinza-texto);"><i class="fas fa-download" style="color: var(--azul-vale);"></i> Passo 1: Baixar modelo</h4>
                        <button class="btn btn-secondary" onclick="baixarModelo()"><i class="fas fa-file-excel"></i> Baixar modelo Excel</button>
                    </div>

                    <div style="background: var(--fundo); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--cinza-texto);"><i class="fas fa-upload" style="color: var(--verde-vale);"></i> Passo 2: Enviar arquivo preenchido</h4>
                        
                        <div id="dropZone">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--azul-vale); margin-bottom: 1rem;"></i>
                            <p style="margin-bottom: 1rem; color: var(--cinza-medio);">Arraste o arquivo Excel aqui ou clique para selecionar</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="processarArquivo(this.files[0])">
                            <button class="btn" onclick="document.getElementById('fileInput').click()"><i class="fas fa-folder-open"></i> Selecionar arquivo</button>
                        </div>
                    </div>

                    <div id="previewContainer" style="display: none;">
                        <h4 style="margin-bottom: 1rem;"><i class="fas fa-eye" style="color: var(--azul-vale);"></i> Passo 3: Revisar e salvar</h4>
                        
                        <div class="table-container" style="background: white; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            <table id="previewTabela">
                                <thead id="previewThead"></thead>
                                <tbody id="previewTbody"></tbody>
                            </table>
                        </div>

                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="salvarEquipamentosExcel()"><i class="fas fa-save"></i> Salvar no Firebase</button>
                            <button class="btn btn-danger" onclick="limparUpload()"><i class="fas fa-trash"></i> Limpar</button>
                        </div>
                    </div>

                    <div id="listaExistente" style="margin-top: 2rem; display: none;">
                        <h4 class="card-title"><i class="fas fa-list"></i> Equipamentos Cadastrados</h4>
                        <div class="table-container" style="background: white; border-radius: 8px; max-height: 400px; overflow-y: auto;">
                            <table id="tabelaExistente">
                                <thead><tr><th>Mês</th><th>Equipamento</th><th>Previsto</th><th>Ação</th></tr></thead>
                                <tbody id="tbodyExistente"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ABA FISCAIS -->
        <div class="tab-content" id="tab-fiscais">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-user-plus"></i> Novo Fiscal</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Nome completo</label>
                        <input type="text" class="form-input" id="novoFiscalNome" placeholder="Ex: João Silva">
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-mail (opcional)</label>
                        <input type="email" class="form-input" id="novoFiscalEmail" placeholder="Ex: joao@email.com">
                    </div>
                </div>
                <button class="btn btn-success" onclick="criarFiscal()"><i class="fas fa-save"></i> Cadastrar Fiscal</button>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-users"></i> Fiscais Cadastrados</h3>
                <div id="fiscaisList"><div class="loading"><div class="spinner"></div><p>Carregando fiscais...</p></div></div>
            </div>

        </div>

        <!-- ABA RDCs -->
        <div class="tab-content" id="tab-rdcs">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-filter"></i> Filtrar RDCs</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Obra</label>
                        <select class="form-select" id="filtroObraRDC" onchange="carregarRDCs()"><option value="">Selecione uma obra...</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Período</label>
                        <select class="form-select" id="filtroPeriodoRDC" onchange="carregarRDCs()">
                            <option value="todos">Todos os RDCs</option>
                            <option value="mes-atual">Mês atual</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="rdcListContainer"><div class="empty-state"><i class="fas fa-clipboard-list"></i><p>Selecione uma obra para ver os RDCs</p></div></div>

        </div>

    </div>

    <!-- Modal Exportar -->
    <div class="modal" id="modalExportar">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-file-excel"></i> Exportar RDCs</h3>
            <div class="form-group">
                <label class="form-label">Obra</label>
                <input type="text" class="form-input" id="exportObraNome" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Período</label>
                <input type="text" class="form-input" id="exportPeriodoNome" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">RDCs encontrados</label>
                <input type="text" class="form-input" id="exportQuantidade" readonly>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalExportar()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarExportacao()"><i class="fas fa-download"></i> Baixar Excel</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm7jQbxnJ2aq6Hf-e3ufkoMi2yc6PjIgE",
            authDomain: "relatorio-obra-geotecnia.firebaseapp.com",
            databaseURL: "https://relatorio-obra-geotecnia-default-rtdb.firebaseio.com",
            projectId: "relatorio-obra-geotecnia",
            storageBucket: "relatorio-obra-geotecnia.firebasestorage.app",
            messagingSenderId: "765646735604",
            appId: "1:765646735604:web:59424d5353813939e976a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbSet = set;
        window.dbPush = push;
        window.dbRemove = remove;
    </script>

    <script>
        // ==================== VARIÁVEIS GLOBAIS ====================
        let obras = {};
        let fiscais = {};
        let obraSelecionada = null;
        let dadosExcel = {};
        let rdcsParaExportar = [];
        let obraExportacao = null;

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', () => {
            carregarObras();
            carregarFiscais();
            
            // Drag and drop
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) processarArquivo(e.dataTransfer.files[0]);
                });
            }
        });

        function sair() { window.location.href = 'index.html'; }
        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function formatarDataBR(dataStr) {
            if (!dataStr) return '-';
            if (dataStr.includes('/')) return dataStr;
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // ==================== OBRAS ====================
        async function carregarObras() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'obras'));
                if (snapshot.exists()) {
                    obras = snapshot.val();
                    renderObrasList();
                    preencherSelectsObras();
                } else {
                    document.getElementById('obrasList').innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Nenhuma obra cadastrada</p></div>';
                }
            } catch (error) { showToast('Erro ao carregar obras', 'error'); }
        }

        function renderObrasList() {
            const container = document.getElementById('obrasList');
            let html = '<div style="margin-bottom: 1rem; font-weight: 600; color: var(--cinza-medio);">Clique em uma obra para gerenciar equipamentos:</div>';
            
            Object.keys(obras).forEach(key => {
                const obra = obras[key];
                const dataInicio = obra.dataInicio ? formatarDataBR(obra.dataInicio) : 'Não definido';
                html += `
                    <div class="obra-item" onclick="selecionarObra('${key}')">
                        <div class="obra-info">
                            <h3>${obra.nome}</h3>
                            <p><i class="fas fa-calendar-alt"></i> Início: ${dataInicio} ${obra.local ? `| <i class="fas fa-map-marker-alt"></i> ${obra.local}` : ''}</p>
                        </div>
                        <div class="obra-actions" onclick="event.stopPropagation();">
                            <button class="btn-icon btn-success" onclick="editarObra('${key}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-danger" onclick="excluirObra('${key}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function preencherSelectsObras() {
            const selectRDC = document.getElementById('filtroObraRDC');
            selectRDC.innerHTML = '<option value="">Selecione uma obra...</option>';
            Object.keys(obras).forEach(key => {
                selectRDC.innerHTML += `<option value="${key}">${obras[key].nome}</option>`;
            });
        }

        async function criarObra() {
            const nome = document.getElementById('novaObraNome').value.trim();
            const dataInicio = document.getElementById('novaObraData').value;
            const local = document.getElementById('novaObraLocal').value.trim();

            if (!nome || !dataInicio) { showToast('Preencha nome e data de início', 'error'); return; }

            try {
                const obraId = nome.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                await window.dbSet(window.dbRef(window.db, `obras/${obraId}`), { nome, dataInicio, local, criadaEm: new Date().toISOString() });
                showToast('Obra criada com sucesso!', 'success');
                document.getElementById('novaObraNome').value = '';
                document.getElementById('novaObraData').value = '';
                document.getElementById('novaObraLocal').value = '';
                carregarObras();
            } catch (error) { showToast('Erro ao criar obra', 'error'); }
        }

        function selecionarObra(obraId) {
            obraSelecionada = obraId;
            document.getElementById('equipamentosEditor').style.display = 'block';
            document.getElementById('equipObraNome').textContent = obras[obraId].nome;
            setTimeout(() => document.getElementById('equipamentosEditor').scrollIntoView({ behavior: 'smooth' }), 100);
            carregarEquipamentosExistentes();
        }

        // ==================== EQUIPAMENTOS - UPLOAD EXCEL ====================
        function baixarModelo() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['Nome do Equipamento', 'Jan/2026', 'Fev/2026', 'Mar/2026', 'Abr/2026', 'Mai/2026', 'Jun/2026', 'Jul/2026', 'Ago/2026', 'Set/2026', 'Out/2026', 'Nov/2026', 'Dez/2026'],
                ['Escavadeira', 1, 2, 3, 3, 3, 3, 3, 2, 2, 2, 1, 0],
                ['Caminhão 14m³', 5, 7, 12, 12, 12, 12, 10, 7, 5, 5, 3, 0],
                ['Trator', 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                ['Retroescavadeira', 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                ['Rolo Compactador', 0, 1, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0],
                ['Motoniveladora', 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0]
            ]);
            XLSX.utils.book_append_sheet(wb, ws, 'Equipamentos');
            XLSX.writeFile(wb, 'modelo_equipamentos_anual.xlsx');
        }

        function processarArquivo(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if (json.length < 2) { showToast('Arquivo vazio ou formato inválido', 'error'); return; }
                    
                    const cabecalho = json[0];
                    const colunasMeses = cabecalho.slice(1).filter(m => m);
                    
                    dadosExcel = {};
                    for (let i = 1; i < json.length; i++) {
                        const linha = json[i];
                        if (!linha[0]) continue;
                        
                        const nomeEquip = String(linha[0]).trim();
                        const equipId = nomeEquip.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                        
                        colunasMeses.forEach((mesColuna, idx) => {
                            if (!mesColuna) return;
                            const mesKey = converterMesParaKey(String(mesColuna));
                            if (!mesKey) return;
                            
                            if (!dadosExcel[mesKey]) dadosExcel[mesKey] = {};
                            dadosExcel[mesKey][equipId] = { nome: nomeEquip, previsto: parseInt(linha[idx + 1]) || 0 };
                        });
                    }
                    
                    const totalMeses = Object.keys(dadosExcel).length;
                    if (totalMeses === 0) { showToast('Nenhum mês válido encontrado', 'error'); return; }
                    
                    mostrarPreview(colunasMeses, json.slice(1));
                    showToast(`${json.length - 1} equipamentos em ${totalMeses} meses carregados`, 'success');
                    
                } catch (error) { showToast('Erro ao ler arquivo', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

function converterMesParaKey(mesStr) {
    // Se for objeto Date do Excel, converter para string primeiro
    if (mesStr instanceof Date) {
        const mes = String(mesStr.getMonth() + 1).padStart(2, '0');
        const ano = mesStr.getFullYear();
        return `${mes}-${ano}`;
    }
    
    // Converter para string se não for
    const str = String(mesStr).trim();
    
    // Se já vier como data completa (01/01/2026 ou 2026-01-01)
    const formatoDataBR = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (formatoDataBR) {
        return `${formatoDataBR[2]}-${formatoDataBR[3]}`; // MM-AAAA
    }
    
    const formatoDataISO = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (formatoDataISO) {
        return `${formatoDataISO[2]}-${formatoDataISO[1]}`; // MM-AAAA
    }
    
    // Mapeamento de meses em português
    const mesesMap = { 
        'jan': '01', 'janeiro': '01', 'jan.': '01',
        'fev': '02', 'fevereiro': '02', 'fev.': '02',
        'mar': '03', 'março': '03', 'marco': '03', 'mar.': '03',
        'abr': '04', 'abril': '04', 'abr.': '04',
        'mai': '05', 'maio': '05', 'mai.': '05',
        'jun': '06', 'junho': '06', 'jun.': '06',
        'jul': '07', 'julho': '07', 'jul.': '07',
        'ago': '08', 'agosto': '08', 'ago.': '08',
        'set': '09', 'setembro': '09', 'set.': '09',
        'out': '10', 'outubro': '10', 'out.': '10',
        'nov': '11', 'novembro': '11', 'nov.': '11',
        'dez': '12', 'dezembro': '12', 'dez.': '12'
    };
    
    // Tenta formato MM/AAAA (01/2026)
    const formatoNumerico = str.match(/^(\d{2})\/(\d{4})$/);
    if (formatoNumerico) {
        return `${formatoNumerico[1]}-${formatoNumerico[2]}`;
    }
    
    // Tenta formato texto (Jan/2026, Janeiro/2026, etc)
    const partes = str.toLowerCase().split(/[\/\s\-]+/);
    const mesEncontrado = partes.find(p => mesesMap[p.replace(/[^a-z.]/g, '')]);
    const anoEncontrado = partes.find(p => /^\d{4}$/.test(p));
    
    if (mesEncontrado && anoEncontrado) {
        const mesNum = mesesMap[mesEncontrado.replace(/[^a-z.]/g, '')];
        return `${mesNum}-${anoEncontrado}`;
    }
    
    // Se não conseguiu converter, loga para debug
    console.warn('Não conseguiu converter:', str);
    return null;
}

        function mostrarPreview(colunasMeses, linhas) {
            const thead = document.getElementById('previewThead');
            const tbody = document.getElementById('previewTbody');
            
            let htmlHead = '<tr><th>Equipamento</th>';
            colunasMeses.forEach(mes => { if (mes) htmlHead += `<th style="text-align:center">${mes}</th>`; });
            htmlHead += '</tr>';
            thead.innerHTML = htmlHead;
            
            let htmlBody = '';
            linhas.slice(0, 10).forEach(linha => {
                if (!linha[0]) return;
                htmlBody += `<tr><td>${linha[0]}</td>`;
                for (let i = 1; i <= colunasMeses.length; i++) {
                    htmlBody += `<td style="text-align:center">${linha[i] !== undefined ? linha[i] : '-'}</td>`;
                }
                htmlBody += '</tr>';
            });
            if (linhas.length > 10) htmlBody += `<tr><td colspan="${colunasMeses.length + 1}" style="text-align:center;color:var(--cinza-medio)">... e mais ${linhas.length - 10} equipamentos</td></tr>`;
            tbody.innerHTML = htmlBody;
            
            document.getElementById('previewContainer').style.display = 'block';
        }

        async function salvarEquipamentosExcel() {
            if (!obraSelecionada || Object.keys(dadosExcel).length === 0) { showToast('Nenhum dado para salvar', 'error'); return; }

            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btn.disabled = true;

            try {
                let salvos = 0;
                for (const mesKey of Object.keys(dadosExcel)) {
                    const equipamentos = {};
                    Object.entries(dadosExcel[mesKey]).forEach(([id, eq]) => {
                        if (eq.previsto > 0) equipamentos[id] = eq;
                    });
                    
                    if (Object.keys(equipamentos).length > 0) {
                        await window.dbSet(window.dbRef(window.db, `obras/${obraSelecionada}/contrato/${mesKey}`), equipamentos);
                        salvos++;
                    }
                }

                showToast(`${salvos} meses salvos com sucesso!`, 'success');
                limparUpload();
                carregarEquipamentosExistentes();
            } catch (error) { showToast('Erro ao salvar', 'error'); }
            finally { btn.innerHTML = originalHTML; btn.disabled = false; }
        }

        function limparUpload() {
            dadosExcel = {};
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('previewThead').innerHTML = '';
            document.getElementById('previewTbody').innerHTML = '';
        }

        async function carregarEquipamentosExistentes() {
            if (!obraSelecionada) return;
            
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, `obras/${obraSelecionada}/contrato`));
                const container = document.getElementById('listaExistente');
                const tbody = document.getElementById('tbodyExistente');
                
                if (snapshot.exists()) {
                    const contratos = snapshot.val();
                    let html = '';
                    let total = 0;
                    
                    Object.keys(contratos).sort().forEach(mesKey => {
                        const [mes, ano] = mesKey.split('-');
                        const data = new Date(ano, mes - 1);
                        const mesNome = data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                        
                        Object.entries(contratos[mesKey]).forEach(([id, eq]) => {
                            total++;
                            html += `<tr><td>${mesNome}</td><td>${eq.nome}</td><td style="text-align:center">${eq.previsto}</td><td style="text-align:center"><button class="btn-icon btn-danger" style="width:30px;height:30px" onclick="excluirEquipamentoMes('${mesKey}','${id}')" title="Excluir"><i class="fas fa-trash" style="font-size:0.8rem"></i></button></td></tr>`;
                        });
                    });
                    
                    tbody.innerHTML = html;
                    container.querySelector('h4').innerHTML = `<i class="fas fa-list"></i> ${total} equipamentos cadastrados`;
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            } catch (error) { console.error(error); }
        }

        async function excluirEquipamentoMes(mesKey, equipId) {
            if (!confirm('Deseja excluir?')) return;
            try {
                await window.dbRemove(window.dbRef(window.db, `obras/${obraSelecionada}/contrato/${mesKey}/${equipId}`));
                showToast('Excluído', 'success');
                carregarEquipamentosExistentes();
            } catch (error) { showToast('Erro', 'error'); }
        }

        // ==================== FISCAIS ====================
        async function carregarFiscais() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'fiscais'));
                if (snapshot.exists()) {
                    fiscais = snapshot.val();
                    renderFiscaisList();
                } else {
                    document.getElementById('fiscaisList').innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i><p>Nenhum fiscal cadastrado</p></div>';
                }
            } catch (error) { showToast('Erro ao carregar fiscais', 'error'); }
        }

        function renderFiscaisList() {
            const container = document.getElementById('fiscaisList');
            let html = '';
            Object.keys(fiscais).forEach(key => {
                const fiscal = fiscais[key];
                const iniciais = fiscal.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                html += `
                    <div class="fiscal-item">
                        <div class="fiscal-info">
                            <div class="fiscal-avatar">${iniciais}</div>
                            <div>
                                <div style="font-weight:600">${fiscal.nome}</div>
                                <div style="font-size:0.85rem;color:var(--cinza-medio)">${fiscal.email || 'Sem e-mail'}</div>
                                <span class="fiscal-status ${fiscal.ativo !== false ? 'ativo' : 'inativo'}">${fiscal.ativo !== false ? 'Ativo' : 'Inativo'}</span>
                            </div>
                        </div>
                        <div class="obra-actions">
                            <button class="btn-icon btn-warning" onclick="toggleFiscal('${key}')" title="${fiscal.ativo !== false ? 'Desativar' : 'Ativar'}"><i class="fas ${fiscal.ativo !== false ? 'fa-pause' : 'fa-play'}"></i></button>
                            <button class="btn-icon btn-danger" onclick="excluirFiscal('${key}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        async function criarFiscal() {
            const nome = document.getElementById('novoFiscalNome').value.trim();
            const email = document.getElementById('novoFiscalEmail').value.trim();
            if (!nome) { showToast('Digite o nome', 'error'); return; }

            try {
                const fiscalId = nome.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                await window.dbSet(window.dbRef(window.db, `fiscais/${fiscalId}`), { nome, email, ativo: true, criadoEm: new Date().toISOString() });
                showToast('Fiscal cadastrado!', 'success');
                document.getElementById('novoFiscalNome').value = '';
                document.getElementById('novoFiscalEmail').value = '';
                carregarFiscais();
            } catch (error) { showToast('Erro ao cadastrar', 'error'); }
        }

        async function toggleFiscal(fiscalId) {
            const novoStatus = fiscais[fiscalId].ativo === false ? true : false;
            try {
                await window.dbSet(window.dbRef(window.db, `fiscais/${fiscalId}/ativo`), novoStatus);
                showToast(`Fiscal ${novoStatus ? 'ativado' : 'desativado'}`, 'success');
                carregarFiscais();
            } catch (error) { showToast('Erro', 'error'); }
        }

        function excluirFiscal(fiscalId) {
            if (!confirm('Deseja excluir?')) return;
            window.dbRemove(window.dbRef(window.db, `fiscais/${fiscalId}`)).then(() => { showToast('Excluído', 'success'); carregarFiscais(); }).catch(() => showToast('Erro', 'error'));
        }

        // ==================== RDCs ====================
        async function carregarRDCs() {
            const obraId = document.getElementById('filtroObraRDC').value;
            const periodo = document.getElementById('filtroPeriodoRDC').value;
            
            if (!obraId) {
                document.getElementById('rdcListContainer').innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>Selecione uma obra</p></div>';
                return;
            }

            const container = document.getElementById('rdcListContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando...</p></div>';

            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, `obras/${obraId}/relatorios`));
                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>Nenhum RDC encontrado</p></div>';
                    return;
                }

                let rdcs = Object.entries(snapshot.val()).map(([id, r]) => ({ id, ...r }));
                const hoje = new Date();
                
                rdcs = rdcs.filter(r => {
                    const dataRDC = new Date(r.dataKey || r.data);
                    switch(periodo) {
                        case 'mes-atual': return dataRDC.getMonth() === hoje.getMonth() && dataRDC.getFullYear() === hoje.getFullYear();
                        case 'ultimos-30': return dataRDC >= new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
                        case 'ultimos-7': return dataRDC >= new Date(hoje.getTime() - (7 * 24 * 60 * 60 * 1000));
                        default: return true;
                    }
                }).sort((a, b) => new Date(b.dataKey || b.data) - new Date(a.dataKey || a.data));

                renderRDCList(rdcs, obraId, periodo);
            } catch (error) { container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar</p></div>'; }
        }

        function renderRDCList(rdcs, obraId, periodo) {
            const container = document.getElementById('rdcListContainer');
            if (rdcs.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Nenhum RDC no período</p></div>';
                return;
            }

            rdcsParaExportar = rdcs;
            obraExportacao = obraId;
            const periodoNomes = { 'todos': 'Todos', 'mes-atual': 'Mês atual', 'ultimos-30': 'Últimos 30 dias', 'ultimos-7': 'Últimos 7 dias' };

            let html = `
                <div class="card" style="background: linear-gradient(135deg, var(--azul-vale) 0%, var(--azul-escuro) 100%); color: white;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="font-style: italic; margin-bottom: 0.5rem;"><i class="fas fa-chart-bar"></i> Resumo</h3>
                            <p>${rdcs.length} RDC(s) | Período: ${periodoNomes[periodo]}</p>
                        </div>
                        <button class="btn" onclick="abrirModalExportar()" style="background: white; color: var(--azul-vale);"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                    </div>
                </div>
                <div style="margin-bottom: 1rem; font-weight: 600; color: var(--cinza-medio);">Lista de RDCs:</div>`;

            rdcs.forEach(rdc => {
                const qtdEquip = rdc.dados?.equipamentos ? Object.keys(rdc.dados.equipamentos).length : 0;
                const dataFormatada = formatarDataBR(rdc.dataKey || rdc.data);
                
                html += `
                    <div class="rdc-item">
                        <div class="rdc-info">
                            <h3><i class="fas fa-file-alt" style="color: var(--azul-vale); margin-right: 0.5rem;"></i>RDC ${rdc.numero || '---'}</h3>
                            <p><i class="fas fa-calendar"></i> ${dataFormatada} | <i class="fas fa-user"></i> ${rdc.fiscalNome || rdc.fiscal} | <i class="fas fa-tools"></i> ${qtdEquip} equip(s)</p>
                            ${rdc.dados?.clima?.condicao ? `<p style="margin-top: 0.3rem;"><i class="fas fa-cloud-sun"></i> ${rdc.dados.clima.condicao} | <i class="fas fa-tint"></i> ${rdc.dados.clima.pluviometro || 0}mm</p>` : ''}
                        </div>
                        <div class="obra-actions">
                            <span class="status-badge status-${rdc.status || 'enviado'}" style="margin-right: 0.5rem;">${rdc.status || 'enviado'}</span>
                            <button class="btn-icon btn-success" onclick="verDetalhesRDC('${rdc.id}')" title="Ver"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
        }

        function abrirModalExportar() {
            const obra = obras[obraExportacao];
            const periodo = document.getElementById('filtroPeriodoRDC').value;
            const periodoNomes = { 'todos': 'Todos os RDCs', 'mes-atual': 'Mês atual', 'ultimos-30': 'Últimos 30 dias', 'ultimos-7': 'Últimos 7 dias' };

            document.getElementById('exportObraNome').value = obra.nome;
            document.getElementById('exportPeriodoNome').value = periodoNomes[periodo];
            document.getElementById('exportQuantidade').value = `${rdcsParaExportar.length} RDC(s)`;
            document.getElementById('modalExportar').classList.add('active');
        }

        function fecharModalExportar() { document.getElementById('modalExportar').classList.remove('active'); }

        async function confirmarExportacao() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btn.disabled = true;

            try {
                const wb = XLSX.utils.book_new();
                
                // ABA GERAL
                const geralData = rdcsParaExportar.map(rdc => ({
                    'RDC': rdc.numero || '-',
                    'Data': formatarDataBR(rdc.dataKey || rdc.data),
                    'Fiscal': rdc.fiscalNome || rdc.fiscal,
                    'Status': rdc.status || 'enviado',
                    'Condição Climática': rdc.dados?.clima?.condicao || '-',
                    'Pluviômetro (mm)': rdc.dados?.clima?.pluviometro || 0,
                    'Qtd Equipamentos': rdc.dados?.equipamentos ? Object.keys(rdc.dados.equipamentos).length : 0,
                    'Atividades': rdc.dados?.atividades?.descricao || '-',
                    'Comentários': rdc.dados?.atividades?.comentarios || '-'
                }));
                
                const wsGeral = XLSX.utils.json_to_sheet(geralData);
                wsGeral['!cols'] = [{wch:10}, {wch:12}, {wch:20}, {wch:12}, {wch:18}, {wch:15}, {wch:18}, {wch:40}, {wch:40}];
                XLSX.utils.book_append_sheet(wb, wsGeral, "Geral");

                // ABA EQUIPAMENTOS
                const equipData = [];
                rdcsParaExportar.forEach(rdc => {
                    if (rdc.dados?.equipamentos) {
                        Object.entries(rdc.dados.equipamentos).forEach(([id, eq]) => {
                            equipData.push({
                                'RDC': rdc.numero || '-',
                                'Data': formatarDataBR(rdc.dataKey || rdc.data),
                                'Fiscal': rdc.fiscalNome || rdc.fiscal,
                                'Equipamento': eq.nome || id,
                                'Previsto': eq.previsto || '-',
                                'Real': eq.real !== undefined ? eq.real : '-',
                                'Manutenção': eq.manutencao || 0,
                                'Observações': eq.obs || '-'
                            });
                        });
                    }
                });
                
                if (equipData.length > 0) {
                    const wsEquip = XLSX.utils.json_to_sheet(equipData);
                    wsEquip['!cols'] = [{wch:10}, {wch:12}, {wch:20}, {wch:25}, {wch:12}, {wch:10}, {wch:12}, {wch:30}];
                    XLSX.utils.book_append_sheet(wb, wsEquip, "Equipamentos");
                }

                XLSX.writeFile(wb, `RDCs_${obras[obraExportacao].nome.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Excel gerado com sucesso!', 'success');
                fecharModalExportar();
            } catch (error) {
                showToast('Erro ao gerar Excel', 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function verDetalhesRDC(rdcId) {
            const rdc = rdcsParaExportar.find(r => r.id === rdcId);
            if (!rdc) return;
            let detalhes = `RDC ${rdc.numero || '-'}\nData: ${formatarDataBR(rdc.dataKey || rdc.data)}\nFiscal: ${rdc.fiscalNome || rdc.fiscal}\n\n`;
            if (rdc.dados?.clima) detalhes += `CLIMA:\nCondição: ${rdc.dados.clima.condicao || '-'}\nPluviômetro: ${rdc.dados.clima.pluviometro || 0}mm\n\n`;
            if (rdc.dados?.equipamentos) {
                detalhes += `EQUIPAMENTOS:\n`;
                Object.entries(rdc.dados.equipamentos).forEach(([id, eq]) => {
                    detalhes += `- ${eq.nome || id}: Real ${eq.real || '-'}, Manut ${eq.manutencao || 0}\n`;
                });
            }
            alert(detalhes);
        }

        function editarObra(id) { showToast('Função em desenvolvimento', 'error'); }
        function excluirObra(id) {
            if (!confirm(`Excluir ${obras[id].nome}?`)) return;
            window.dbRemove(window.dbRef(window.db, `obras/${id}`)).then(() => { showToast('Obra excluída', 'success'); carregarObras(); document.getElementById('equipamentosEditor').style.display = 'none'; }).catch(() => showToast('Erro', 'error'));
        }

        document.getElementById('modalExportar').addEventListener('click', (e) => { if (e.target.id === 'modalExportar') fecharModalExportar(); });
    </script>
</body>
</html>
