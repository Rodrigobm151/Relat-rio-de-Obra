<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squad Geotecnia - Painel Administrativo</title>
    
    <!-- Fonte Vale Sans -->
    <link rel="preload" href="assets/fonts/ValeSans-Italic.woff2" as="font" type="font/woff2" crossorigin>
    <style>
        @font-face {
            font-family: 'Vale Sans';
            src: url('assets/fonts/ValeSans-Italic.woff2') format('woff2');
            font-weight: 400;
            font-style: italic;
            font-display: swap;
        }
        @font-face {
            font-family: 'Vale Sans';
            src: url('assets/fonts/ValeSans-BoldItalic.woff2') format('woff2');
            font-weight: 700;
            font-style: italic;
            font-display: swap;
        }
    </style>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            /* Paleta Principal VBM */
            --azul-vale: #3CB5E5;
            --azul-escuro: #0096d2;
            --verde-vale: #007E79;
            --cinza-texto: #555555;
            --cinza-medio: #747678;
            --cinza-claro: #BCBEC0;
            --cinza-fundo: #E6E7E8;
            --branco: #FFFFFF;
            --laranja: #ff9800;
            --vermelho: #e74c3c;
            
            /* Gradientes */
            --gradiente-header: linear-gradient(135deg, #3CB5E5 0%, #007E79 100%);
            --gradiente-card: linear-gradient(145deg, #ffffff 0%, #f0f4f8 100%);
            --gradiente-success: linear-gradient(135deg, #007E79 0%, #006b66 100%);
            --gradiente-danger: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --gradiente-sidebar: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            
            /* Sombras */
            --sombra-suave: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sombra-card: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --sombra-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Vale Sans', 'Inter', sans-serif;
            font-style: italic;
            background: var(--gradiente-sidebar);
            color: var(--cinza-texto); 
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* SCROLLBAR PERSONALIZADA - OCULTA A BARRA LATERAL */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--cinza-claro);
            border-radius: 4px;
            opacity: 0;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--azul-vale);
            opacity: 1;
        }
        
        * {
            scrollbar-width: thin;
            scrollbar-color: transparent transparent;
        }
        
        *:hover {
            scrollbar-color: var(--cinza-claro) transparent;
        }

        /* HEADER COM GRADIENTE */
        .header {
            background: var(--gradiente-header);
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--sombra-suave);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>');
            background-size: 50px 50px;
            opacity: 0.3;
            pointer-events: none;
        }

        .header-content {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .header h1 { 
            font-size: 1.4rem; 
            font-weight: 700; 
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-sair { 
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: white; 
            padding: 10px 24px; 
            border-radius: 30px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            font-family: 'Vale Sans', sans-serif;
            font-style: italic;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-sair:hover { 
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 30px 40px;
            width: 100%;
            flex: 1;
        }

        /* NAVEGAÇÃO POR ABAS ESTILIZADA */
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 30px; 
            border-bottom: 2px solid var(--cinza-fundo);
            background: white;
            padding: 0 20px;
            border-radius: 12px 12px 0 0;
            box-shadow: var(--sombra-card);
        }
        
        .tab-btn { 
            background: none; 
            border: none; 
            padding: 20px 30px; 
            cursor: pointer; 
            font-size: 0.95rem; 
            color: var(--cinza-medio); 
            border-bottom: 3px solid transparent; 
            margin-bottom: -2px; 
            transition: all 0.3s ease; 
            white-space: nowrap;
            font-family: 'Vale Sans', sans-serif;
            font-style: italic;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(60, 181, 229, 0.1), transparent);
            transition: left 0.5s;
        }

        .tab-btn:hover::before {
            left: 100%;
        }
        
        .tab-btn.active { 
            color: var(--azul-vale); 
            border-bottom-color: var(--azul-vale); 
            background: linear-gradient(180deg, transparent 0%, rgba(60, 181, 229, 0.08) 100%);
        }
        
        .tab-btn:hover { 
            color: var(--azul-vale);
            background: linear-gradient(180deg, transparent 0%, rgba(60, 181, 229, 0.05) 100%);
        }

        .tab-content { 
            display: none; 
            animation: fadeIn 0.3s ease; 
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* CARDS ESTILIZADOS */
        .card { 
            background: var(--gradiente-card); 
            border-radius: 16px; 
            padding: 30px; 
            margin-bottom: 25px; 
            box-shadow: var(--sombra-card);
            border: 1px solid rgba(255,255,255,0.5);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--sombra-hover);
        }
        
        .card-title { 
            color: var(--azul-vale); 
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 20px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .grid-2 { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        
        .grid-3 { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; 
            gap: 20px; 
        }
        
        @media (max-width: 768px) { 
            .grid-2, .grid-3 { 
                grid-template-columns: 1fr; 
            } 
            
            .container, .header {
                padding-left: 20px;
                padding-right: 20px;
            }
        }

        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-label { 
            display: block; 
            font-size: 0.9rem; 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: var(--cinza-texto); 
        }
        
        .form-input, .form-select { 
            width: 100%; 
            padding: 14px; 
            border: 2px solid var(--cinza-fundo); 
            border-radius: 10px; 
            font-size: 1rem; 
            transition: all 0.3s ease;
            font-family: 'Vale Sans', sans-serif;
            font-style: italic;
            background: white;
        }
        
        .form-input:focus, .form-select:focus { 
            outline: none; 
            border-color: var(--azul-vale);
            box-shadow: 0 0 0 3px rgba(60, 181, 229, 0.1);
        }

        /* BOTÕES ESTILIZADOS */
        .btn { 
            background: var(--azul-vale); 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 10px; 
            font-size: 0.95rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: inline-flex; 
            align-items: center; 
            gap: 8px;
            font-family: 'Vale Sans', sans-serif;
            font-style: italic;
            box-shadow: 0 4px 6px rgba(60, 181, 229, 0.3);
        }
        
        .btn:hover { 
            background: var(--azul-escuro); 
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(60, 181, 229, 0.4);
        }
        
        .btn-success { 
            background: var(--verde-vale);
            box-shadow: 0 4px 6px rgba(0, 126, 121, 0.3);
        }
        
        .btn-success:hover { 
            background: #006b66; 
            box-shadow: 0 6px 12px rgba(0, 126, 121, 0.4);
        }
        
        .btn-danger { 
            background: var(--vermelho);
            box-shadow: 0 4px 6px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover { 
            background: #c0392b; 
            box-shadow: 0 6px 12px rgba(231, 76, 60, 0.4);
        }
        
        .btn-warning { 
            background: var(--laranja); 
        }
        
        .btn-secondary { 
            background: var(--cinza-fundo); 
            color: var(--cinza-texto);
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .btn-secondary:hover { 
            background: var(--cinza-claro); 
        }

        /* ITENS DE OBRA */
        .obra-item { 
            background: white; 
            border-radius: 16px; 
            padding: 25px; 
            margin-bottom: 15px; 
            box-shadow: var(--sombra-card); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.3s ease; 
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .obra-item:hover { 
            transform: translateX(8px); 
            box-shadow: var(--sombra-hover);
            border-left: 4px solid var(--azul-vale);
        }
        
        .obra-info h3 { 
            font-size: 1.2rem; 
            color: var(--cinza-texto); 
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .obra-info p { 
            font-size: 0.9rem; 
            color: var(--cinza-medio);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .obra-actions { 
            display: flex; 
            gap: 10px; 
        }
        
        .btn-icon { 
            width: 45px; 
            height: 45px; 
            border-radius: 12px; 
            border: none; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .btn-icon:hover { 
            transform: scale(1.15) rotate(5deg);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* FISCAIS */
        .fiscal-item { 
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: var(--sombra-card); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            transition: all 0.3s ease;
        }

        .fiscal-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--sombra-hover);
        }
        
        .fiscal-info { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .fiscal-avatar { 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            background: var(--gradiente-header); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.3rem; 
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(60, 181, 229, 0.3);
        }
        
        .fiscal-status { 
            display: inline-block; 
            padding: 6px 12px; 
            border-radius: 20px; 
            font-size: 0.8rem; 
            font-weight: 700; 
            margin-top: 5px;
        }
        
        .fiscal-status.ativo { 
            background: rgba(0, 126, 121, 0.1); 
            color: var(--verde-vale); 
        }
        
        .fiscal-status.inativo { 
            background: rgba(231, 76, 60, 0.1); 
            color: var(--vermelho); 
        }

        /* EQUIPAMENTOS */
        .equip-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        .equip-info { 
            background: var(--gradiente-sidebar); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px;
            border-left: 4px solid var(--azul-vale);
        }
        
        .equip-info p { 
            margin: 8px 0; 
            font-size: 0.95rem; 
            color: var(--cinza-medio); 
        }
        
        .equip-info strong { 
            color: var(--cinza-texto); 
        }

        .dica-box { 
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%); 
            border-left: 4px solid var(--azul-vale); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 25px; 
            font-size: 0.95rem; 
            color: var(--cinza-texto);
            box-shadow: 0 2px 8px rgba(60, 181, 229, 0.1);
        }
        
        .dica-box i { 
            color: var(--azul-vale); 
            margin-right: 8px; 
        }

        #dropZone { 
            border: 3px dashed var(--cinza-claro); 
            border-radius: 16px; 
            padding: 50px; 
            text-align: center; 
            background: white; 
            transition: all 0.3s ease;
        }
        
        #dropZone.dragover { 
            border-color: var(--azul-vale); 
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
            transform: scale(1.02);
        }

        .table-container { 
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--sombra-card);
            background: white;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.95rem; 
        }
        
        th, td { 
            padding: 16px; 
            text-align: left; 
            border-bottom: 1px solid var(--cinza-fundo); 
        }
        
        th { 
            background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
            font-weight: 700; 
            color: var(--cinza-texto);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        
        tr:hover { 
            background: rgba(60, 181, 229, 0.05); 
        }

        /* RDCs */
        .rdc-item { 
            background: white; 
            border-radius: 16px; 
            padding: 25px; 
            margin-bottom: 15px; 
            box-shadow: var(--sombra-card); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: all 0.3s ease;
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .rdc-item:hover { 
            transform: translateY(-5px); 
            box-shadow: var(--sombra-hover);
        }
        
        .rdc-info h3 { 
            font-size: 1.2rem; 
            color: var(--cinza-texto); 
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .rdc-info p { 
            font-size: 0.9rem; 
            color: var(--cinza-medio);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-badge { 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 0.85rem; 
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-enviado { 
            background: rgba(0, 126, 121, 0.1); 
            color: var(--verde-vale); 
        }
        
        .status-rascunho { 
            background: rgba(255, 152, 0, 0.1); 
            color: var(--laranja); 
        }
        
        .status-pendente { 
            background: rgba(231, 76, 60, 0.1); 
            color: var(--vermelho); 
        }

        .export-card { 
            background: var(--gradiente-success); 
            color: white; 
            border-radius: 16px; 
            padding: 30px; 
            margin-bottom: 25px;
            box-shadow: var(--sombra-card);
        }
        
        .export-card h3 { 
            margin-bottom: 20px; 
            font-weight: 700;
            font-size: 1.3rem;
        }
        
        .export-card .form-select { 
            background: white; 
            color: var(--cinza-texto);
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* LOADING */
        .loading { 
            text-align: center; 
            padding: 60px; 
        }
        
        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 4px solid var(--cinza-fundo); 
            border-top-color: var(--azul-vale); 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
            margin: 0 auto 20px; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }

        .empty-state { 
            text-align: center; 
            padding: 60px; 
            color: var(--cinza-medio); 
            background: white;
            border-radius: 16px;
            box-shadow: var(--sombra-card);
        }
        
        .empty-state i { 
            font-size: 4rem; 
            margin-bottom: 20px; 
            color: var(--cinza-claro); 
        }

        /* TOAST */
        .toast { 
            position: fixed; 
            top: 90px; 
            right: 30px; 
            background: var(--cinza-texto); 
            color: white; 
            padding: 16px 24px; 
            border-radius: 12px; 
            opacity: 0; 
            transition: all 0.3s ease; 
            z-index: 1000; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-weight: 600;
            transform: translateX(100px);
        }
        
        .toast.show { 
            opacity: 1;
            transform: translateX(0);
        }
        
        .toast.success { 
            background: var(--verde-vale); 
        }
        
        .toast.error { 
            background: var(--vermelho); 
        }

        /* MODAL */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 200; 
            align-items: center; 
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.active { 
            display: flex; 
        }
        
        .modal-content { 
            background: white; 
            border-radius: 20px; 
            padding: 40px; 
            max-width: 600px; 
            width: 90%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-title { 
            color: var(--azul-vale); 
            font-size: 1.5rem; 
            font-weight: 700; 
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .modal-footer { 
            display: flex; 
            gap: 15px; 
            margin-top: 30px; 
        }
        
        .modal-footer .btn { 
            flex: 1; 
            justify-content: center; 
        }

        /* SELEÇÃO DE FISCAIS */
        .fiscais-selecao {
            background: var(--gradiente-sidebar);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--cinza-fundo);
        }
        
        .fiscal-checkbox {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .fiscal-checkbox:hover {
            border-color: var(--azul-vale);
            transform: translateX(8px);
            box-shadow: 0 4px 12px rgba(60, 181, 229, 0.15);
        }
        
        .fiscal-checkbox input[type="checkbox"] {
            width: 22px;
            height: 22px;
            margin-right: 15px;
            cursor: pointer;
            accent-color: var(--azul-vale);
        }
        
        .fiscal-checkbox label {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .fiscal-checkbox .fiscal-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradiente-header);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(60, 181, 229, 0.3);
        }
        
        .fiscal-checkbox.inativo {
            opacity: 0.5;
        }
        
        .fiscais-vinculados-lista {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        
        .fiscal-tag {
            background: var(--gradiente-header);
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(60, 181, 229, 0.3);
        }
        
        .fiscal-tag i {
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .fiscal-tag i:hover {
            color: var(--vermelho);
            transform: scale(1.2);
        }
        
        .secao-fiscais {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid var(--cinza-fundo);
        }

        /* RODAPÉ DISCRETO */
        .footer {
            background: linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.02) 100%);
            padding: 20px 40px;
            border-top: 1px solid var(--cinza-fundo);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--cinza-claro);
            margin-top: auto;
        }

        .footer-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .footer-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.6;
            transition: all 0.3s ease;
        }

        .footer-brand:hover {
            opacity: 1;
        }

        .footer-logo {
            height: 22px;
            width: auto;
            filter: grayscale(100%);
            transition: filter 0.3s;
        }

        .footer-brand:hover .footer-logo {
            filter: grayscale(0%);
        }

        .footer-text {
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .footer-right {
            display: flex;
            gap: 25px;
        }

        .footer-link {
            color: var(--cinza-claro);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .footer-link:hover {
            color: var(--azul-vale);
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-cog fa-spin" style="animation-duration: 10s;"></i> Painel Administrativo</h1>
            <button class="btn-sair" onclick="sair()">
                <i class="fas fa-sign-out-alt"></i> 
                Sair
            </button>
        </div>
    </header>

    <div class="container">
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('obras', this)">
                <i class="fas fa-building"></i> 
                Obras e Equipamentos
            </button>
            <button class="tab-btn" onclick="switchTab('fiscais', this)">
                <i class="fas fa-users"></i> 
                Fiscais
            </button>
            <button class="tab-btn" onclick="switchTab('rdcs', this)">
                <i class="fas fa-clipboard-list"></i> 
                RDCs
            </button>
        </div>

        <!-- ABA OBRAS E EQUIPAMENTOS -->
        <div class="tab-content active" id="tab-obras">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-plus-circle"></i> Nova Obra</h3>
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">Nome da obra</label>
                        <input type="text" class="form-input" id="novaObraNome" placeholder="Ex: Mineração Sul">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de início</label>
                        <input type="date" class="form-input" id="novaObraData">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Localização</label>
                        <input type="text" class="form-input" id="novaObraLocal" placeholder="Ex: Carajás - PA">
                    </div>
                </div>
                
                <!-- SELEÇÃO DE FISCAIS PARA NOVA OBRA -->
                <div class="secao-fiscais">
                    <label class="form-label"><i class="fas fa-users-cog"></i> Vincular Fiscais à Obra</label>
                    <div class="dica-box" style="margin-bottom: 0.5rem;">
                        <i class="fas fa-info-circle"></i>
                        Selecione 1 a 4 fiscais que terão acesso a esta obra. Apenas fiscais ativos são exibidos.
                    </div>
                    <div id="fiscaisSelecaoNovaObra" class="fiscais-selecao">
                        <p style="color: var(--cinza-medio); text-align: center; padding: 1rem;">Carregando fiscais...</p>
                    </div>
                    <div id="fiscaisSelecionadosNovaObra" class="fiscais-vinculados-lista"></div>
                </div>
                
                <button class="btn btn-success" onclick="criarObra()" style="margin-top: 1rem;">
                    <i class="fas fa-save"></i> 
                    Criar Obra
                </button>
            </div>

            <div id="obrasList">
                <div class="loading"><div class="spinner"></div><p>Carregando obras...</p></div>
            </div>

            <div id="equipamentosEditor" style="display: none;">
                <div class="card">
                    <div class="equip-header">
                        <div>
                            <h3 class="card-title"><i class="fas fa-edit"></i> Gerenciar Obra</h3>
                        </div>
                    </div>

                    <div class="equip-info">
                        <p><strong>Obra:</strong> <span id="equipObraNome">-</span></p>
                    </div>

                    <!-- SEÇÃO FISCAIS VINCULADOS -->
                    <div class="secao-fiscais" style="margin-top: 0; border-top: none; padding-top: 0;">
                        <h4 class="card-title" style="font-size: 1.1rem;"><i class="fas fa-users"></i> Fiscais Vinculados</h4>
                        <div class="dica-box" style="margin-bottom: 0.5rem;">
                            <i class="fas fa-info-circle"></i>
                            Selecione os fiscais que terão acesso a esta obra. Máximo 4 fiscais.
                        </div>
                        <div id="fiscaisSelecaoObra" class="fiscais-selecao">
                            <p style="color: var(--cinza-medio); text-align: center; padding: 1rem;">Carregando fiscais...</p>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-success" onclick="salvarFiscaisObra()">
                                <i class="fas fa-save"></i> 
                                Salvar Fiscais
                            </button>
                        </div>
                        <div id="fiscaisVinculadosObra" class="fiscais-vinculados-lista" style="margin-top: 1rem;"></div>
                    </div>

                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--cinza-fundo);">
                        <h4 class="card-title"><i class="fas fa-file-excel"></i> Importar Equipamentos</h4>
                    </div>

                    <div class="dica-box">
                        <i class="fas fa-lightbulb"></i>
                        <strong>Como importar:</strong> Baixe o modelo, preencha com os meses no formato <strong>Jan/2026, Fev/2026...</strong> e faça o upload. O sistema salvará todos os meses automaticamente.
                    </div>

                    <div style="background: var(--gradiente-sidebar); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--cinza-texto); font-weight: 600;">
                            <i class="fas fa-download" style="color: var(--azul-vale); margin-right: 8px;"></i> 
                            Passo 1: Baixar modelo
                        </h4>
                        <button class="btn btn-secondary" onclick="baixarModelo()">
                            <i class="fas fa-file-excel"></i> 
                            Baixar modelo Excel
                        </button>
                    </div>

                    <div style="background: var(--gradiente-sidebar); padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--cinza-texto); font-weight: 600;">
                            <i class="fas fa-upload" style="color: var(--verde-vale); margin-right: 8px;"></i> 
                            Passo 2: Enviar arquivo preenchido
                        </h4>
                        
                        <div id="dropZone">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3.5rem; color: var(--azul-vale); margin-bottom: 1.5rem;"></i>
                            <p style="margin-bottom: 1.5rem; color: var(--cinza-medio); font-size: 1.1rem;">Arraste o arquivo Excel aqui ou clique para selecionar</p>
                            <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none;" onchange="processarArquivo(this.files[0])">
                            <button class="btn" onclick="document.getElementById('fileInput').click()">
                                <i class="fas fa-folder-open"></i> 
                                Selecionar arquivo
                            </button>
                        </div>
                    </div>

                    <div id="previewContainer" style="display: none;">
                        <h4 style="margin-bottom: 1.5rem; font-weight: 600;">
                            <i class="fas fa-eye" style="color: var(--azul-vale); margin-right: 8px;"></i> 
                            Passo 3: Revisar e salvar
                        </h4>
                        
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table id="previewTabela">
                                <thead id="previewThead"></thead>
                                <tbody id="previewTbody"></tbody>
                            </table>
                        </div>

                        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                            <button class="btn btn-success" onclick="salvarEquipamentosExcel()">
                                <i class="fas fa-save"></i> 
                                Salvar no Firebase
                            </button>
                            <button class="btn btn-danger" onclick="limparUpload()">
                                <i class="fas fa-trash"></i> 
                                Limpar
                            </button>
                        </div>
                    </div>

                    <div id="listaExistente" style="margin-top: 2.5rem; display: none;">
                        <h4 class="card-title"><i class="fas fa-list"></i> Equipamentos Cadastrados</h4>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table id="tabelaExistente">
                                <thead><tr><th>Mês</th><th>Equipamento</th><th>Previsto</th><th>Ação</th></tr></thead>
                                <tbody id="tbodyExistente"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ABA FISCAIS -->
        <div class="tab-content" id="tab-fiscais">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-user-plus"></i> Novo Fiscal</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Nome completo</label>
                        <input type="text" class="form-input" id="novoFiscalNome" placeholder="Ex: João Silva">
                    </div>
                    <div class="form-group">
                        <label class="form-label">E-mail (opcional)</label>
                        <input type="email" class="form-input" id="novoFiscalEmail" placeholder="Ex: joao@email.com">
                    </div>
                </div>
                <button class="btn btn-success" onclick="criarFiscal()">
                    <i class="fas fa-save"></i> 
                    Cadastrar Fiscal
                </button>
            </div>

            <div class="card">
                <h3 class="card-title"><i class="fas fa-users"></i> Fiscais Cadastrados</h3>
                <div id="fiscaisList">
                    <div class="loading"><div class="spinner"></div><p>Carregando fiscais...</p></div>
                </div>
            </div>

        </div>

        <!-- ABA RDCs -->
        <div class="tab-content" id="tab-rdcs">
            
            <div class="card">
                <h3 class="card-title"><i class="fas fa-filter"></i> Filtrar RDCs</h3>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">Obra</label>
                        <select class="form-select" id="filtroObraRDC" onchange="carregarRDCs()">
                            <option value="">Selecione uma obra...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Período</label>
                        <select class="form-select" id="filtroPeriodoRDC" onchange="carregarRDCs()">
                            <option value="todos">Todos os RDCs</option>
                            <option value="mes-atual">Mês atual</option>
                            <option value="ultimos-30">Últimos 30 dias</option>
                            <option value="ultimos-7">Últimos 7 dias</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="rdcListContainer">
                <div class="empty-state">
                    <i class="fas fa-clipboard-list"></i>
                    <p>Selecione uma obra para ver os RDCs</p>
                </div>
            </div>

        </div>

    </div>

    <!-- Modal Exportar -->
    <div class="modal" id="modalExportar">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-file-excel"></i> Exportar RDCs</h3>
            <div class="form-group">
                <label class="form-label">Obra</label>
                <input type="text" class="form-input" id="exportObraNome" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Período</label>
                <input type="text" class="form-input" id="exportPeriodoNome" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">RDCs encontrados</label>
                <input type="text" class="form-input" id="exportQuantidade" readonly>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="fecharModalExportar()">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarExportacao()">
                    <i class="fas fa-download"></i> 
                    Baixar Excel
                </button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- RODAPÉ -->
    <footer class="footer">
        <div class="footer-left">
            <span>© 2026 Vale Base Metals - Sistema RDC</span>
            <span style="color: var(--cinza-claro);">|</span>
            <div class="footer-brand">
                <span class="footer-text">developed by</span>
                <img src="assets/imagens/reta-logo.png" alt="RETA" class="footer-logo" onerror="this.style.display='none'">
            </div>
        </div>
        <div class="footer-right">
            <a href="#" class="footer-link">Suporte</a>
            <a href="#" class="footer-link">Documentação</a>
            <a href="#" class="footer-link">Versão 2.0</a>
        </div>
    </footer>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, get, set, push, remove, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDm7jQbxnJ2aq6Hf-e3ufkoMi2yc6PjIgE",
            authDomain: "relatorio-obra-geotecnia.firebaseapp.com",
            databaseURL: "https://relatorio-obra-geotecnia-default-rtdb.firebaseio.com",
            projectId: "relatorio-obra-geotecnia",
            storageBucket: "relatorio-obra-geotecnia.firebasestorage.app",
            messagingSenderId: "765646735604",
            appId: "1:765646735604:web:59424d5353813939e976a1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.dbRef = ref;
        window.dbGet = get;
        window.dbSet = set;
        window.dbPush = push;
        window.dbRemove = remove;
        window.dbUpdate = update;
    </script>

    <script>
        // ==================== VARIÁVEIS GLOBAIS ====================
        let obras = {};
        let fiscais = {};
        let obraSelecionada = null;
        let dadosExcel = {};
        let rdcsParaExportar = [];
        let obraExportacao = null;
        let fiscaisSelecionadosNovaObra = [];
        let fiscaisSelecionadosObra = [];

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', () => {
            carregarObras();
            carregarFiscais();
            carregarFiscaisParaNovaObra();
            
            // Drag and drop
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
                dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length > 0) processarArquivo(e.dataTransfer.files[0]);
                });
            }
        });

        function sair() { window.location.href = 'index.html'; }
        
        function switchTab(tab, btn) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function formatarDataBR(dataStr) {
            if (!dataStr) return '-';
            if (dataStr.includes('/')) return dataStr;
            const [ano, mes, dia] = dataStr.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        // ==================== FISCAIS - CARREGAR PARA SELEÇÃO ====================
        async function carregarFiscaisParaNovaObra() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'fiscais'));
                const container = document.getElementById('fiscaisSelecaoNovaObra');
                
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="color: var(--cinza-medio); text-align: center; padding: 1rem;">Nenhum fiscal cadastrado. Cadastre fiscais primeiro.</p>';
                    return;
                }
                
                fiscais = snapshot.val();
                renderFiscaisCheckbox(container, 'nova');
            } catch (error) {
                console.error(error);
            }
        }

        function renderFiscaisCheckbox(container, tipo) {
            let html = '';
            const selecionados = tipo === 'nova' ? fiscaisSelecionadosNovaObra : fiscaisSelecionadosObra;
            
            Object.keys(fiscais).forEach(key => {
                const fiscal = fiscais[key];
                const isAtivo = fiscal.ativo !== false;
                const isSelecionado = selecionados.includes(key);
                const iniciais = fiscal.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                
                html += `
                    <div class="fiscal-checkbox ${!isAtivo ? 'inativo' : ''}" onclick="toggleFiscalCheckbox('${key}', '${tipo}')">
                        <input type="checkbox" ${isSelecionado ? 'checked' : ''} ${!isAtivo ? 'disabled' : ''} 
                               onchange="toggleFiscalCheckbox('${key}', '${tipo}')" 
                               onclick="event.stopPropagation()">
                        <label>
                            <div class="fiscal-avatar-small">${iniciais}</div>
                            <div>
                                <div style="font-weight: 700; font-size: 0.95rem;">${fiscal.nome}</div>
                                <div style="font-size: 0.8rem; color: var(--cinza-medio);">
                                    ${!isAtivo ? '<span style="color: var(--vermelho); font-weight: 600;">Inativo</span>' : (fiscal.email || 'Sem e-mail')}
                                </div>
                            </div>
                        </label>
                    </div>`;
            });
            
            container.innerHTML = html;
            atualizarTagsFiscais(tipo);
        }

        function toggleFiscalCheckbox(fiscalId, tipo) {
            const selecionados = tipo === 'nova' ? fiscaisSelecionadosNovaObra : fiscaisSelecionadosObra;
            const maxFiscais = 4;
            
            const index = selecionados.indexOf(fiscalId);
            
            if (index > -1) {
                selecionados.splice(index, 1);
            } else {
                if (selecionados.length >= maxFiscais) {
                    showToast(`Máximo de ${maxFiscais} fiscais permitidos`, 'error');
                    return;
                }
                selecionados.push(fiscalId);
            }
            
            const container = tipo === 'nova' ? document.getElementById('fiscaisSelecaoNovaObra') : document.getElementById('fiscaisSelecaoObra');
            renderFiscaisCheckbox(container, tipo);
        }

        function atualizarTagsFiscais(tipo) {
            const container = tipo === 'nova' ? document.getElementById('fiscaisSelecionadosNovaObra') : document.getElementById('fiscaisVinculadosObra');
            const selecionados = tipo === 'nova' ? fiscaisSelecionadosNovaObra : fiscaisSelecionadosObra;
            
            let html = '';
            selecionados.forEach(fiscalId => {
                const fiscal = fiscais[fiscalId];
                if (fiscal) {
                    html += `
                        <div class="fiscal-tag">
                            ${fiscal.nome}
                            <i class="fas fa-times" onclick="removerFiscal('${fiscalId}', '${tipo}')"></i>
                        </div>`;
                }
            });
            
            container.innerHTML = html || '<span style="color: var(--cinza-claro); font-size: 0.9rem;">Nenhum fiscal selecionado</span>';
        }

        function removerFiscal(fiscalId, tipo) {
            const selecionados = tipo === 'nova' ? fiscaisSelecionadosNovaObra : fiscaisSelecionadosObra;
            const index = selecionados.indexOf(fiscalId);
            
            if (index > -1) {
                selecionados.splice(index, 1);
                const container = tipo === 'nova' ? document.getElementById('fiscaisSelecaoNovaObra') : document.getElementById('fiscaisSelecaoObra');
                renderFiscaisCheckbox(container, tipo);
            }
        }

        // ==================== OBRAS ====================
        async function carregarObras() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'obras'));
                if (snapshot.exists()) {
                    obras = snapshot.val();
                    renderObrasList();
                    preencherSelectsObras();
                } else {
                    document.getElementById('obrasList').innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>Nenhuma obra cadastrada</p></div>';
                }
            } catch (error) { showToast('Erro ao carregar obras', 'error'); }
        }

        function renderObrasList() {
            const container = document.getElementById('obrasList');
            let html = '<div style="margin-bottom: 1.5rem; font-weight: 700; color: var(--cinza-medio); font-size: 1.1rem;">Clique em uma obra para gerenciar:</div>';
            
            Object.keys(obras).forEach(key => {
                const obra = obras[key];
                const dataInicio = obra.dataInicio ? formatarDataBR(obra.dataInicio) : 'Não definido';
                const qtdFiscais = obra.fiscais ? obra.fiscais.length : 0;
                
                html += `
                    <div class="obra-item" onclick="selecionarObra('${key}')">
                        <div class="obra-info">
                            <h3>${obra.nome}</h3>
                            <p><i class="fas fa-calendar-alt"></i> Início: ${dataInicio} ${obra.local ? `| <i class="fas fa-map-marker-alt"></i> ${obra.local}` : ''}</p>
                            <p style="margin-top: 0.3rem;"><i class="fas fa-users" style="color: var(--azul-vale);"></i> ${qtdFiscais} fiscal(is) vinculado(s)</p>
                        </div>
                        <div class="obra-actions" onclick="event.stopPropagation();">
                            <button class="btn-icon btn-success" onclick="editarObra('${key}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-danger" onclick="excluirObra('${key}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        function preencherSelectsObras() {
            const selectRDC = document.getElementById('filtroObraRDC');
            selectRDC.innerHTML = '<option value="">Selecione uma obra...</option>';
            Object.keys(obras).forEach(key => {
                selectRDC.innerHTML += `<option value="${key}">${obras[key].nome}</option>`;
            });
        }

        async function criarObra() {
            const nome = document.getElementById('novaObraNome').value.trim();
            const dataInicio = document.getElementById('novaObraData').value;
            const local = document.getElementById('novaObraLocal').value.trim();

            if (!nome || !dataInicio) { showToast('Preencha nome e data de início', 'error'); return; }

            try {
                const obraId = nome.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                
                const obraData = { 
                    nome, 
                    dataInicio, 
                    local, 
                    criadaEm: new Date().toISOString() 
                };
                
                if (fiscaisSelecionadosNovaObra.length > 0) {
                    obraData.fiscais = fiscaisSelecionadosNovaObra;
                }
                
                await window.dbSet(window.dbRef(window.db, `obras/${obraId}`), obraData);
                
                showToast('Obra criada com sucesso!', 'success');
                
                document.getElementById('novaObraNome').value = '';
                document.getElementById('novaObraData').value = '';
                document.getElementById('novaObraLocal').value = '';
                fiscaisSelecionadosNovaObra = [];
                atualizarTagsFiscais('nova');
                
                carregarObras();
            } catch (error) { 
                showToast('Erro ao criar obra', 'error'); 
                console.error(error);
            }
        }

        async function selecionarObra(obraId) {
            obraSelecionada = obraId;
            const obra = obras[obraId];
            
            document.getElementById('equipamentosEditor').style.display = 'block';
            document.getElementById('equipObraNome').textContent = obra.nome;
            
            fiscaisSelecionadosObra = obra.fiscais || [];
            
            await carregarFiscaisParaObra();
            
            setTimeout(() => document.getElementById('equipamentosEditor').scrollIntoView({ behavior: 'smooth' }), 100);
            carregarEquipamentosExistentes();
        }

        async function carregarFiscaisParaObra() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'fiscais'));
                const container = document.getElementById('fiscaisSelecaoObra');
                
                if (!snapshot.exists()) {
                    container.innerHTML = '<p style="color: var(--cinza-medio); text-align: center; padding: 1rem;">Nenhum fiscal cadastrado.</p>';
                    return;
                }
                
                fiscais = snapshot.val();
                renderFiscaisCheckbox(container, 'obra');
            } catch (error) {
                console.error(error);
            }
        }

        async function salvarFiscaisObra() {
            if (!obraSelecionada) {
                showToast('Nenhuma obra selecionada', 'error');
                return;
            }

            try {
                await window.dbUpdate(window.dbRef(window.db, `obras/${obraSelecionada}`), {
                    fiscais: fiscaisSelecionadosObra
                });
                
                obras[obraSelecionada].fiscais = fiscaisSelecionadosObra;
                
                showToast('Fiscais vinculados com sucesso!', 'success');
                renderObrasList();
            } catch (error) {
                showToast('Erro ao salvar fiscais', 'error');
                console.error(error);
            }
        }

        // ==================== EQUIPAMENTOS - UPLOAD EXCEL ====================
        function baixarModelo() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['Nome do Equipamento', 'Jan/2026', 'Fev/2026', 'Mar/2026', 'Abr/2026', 'Mai/2026', 'Jun/2026', 'Jul/2026', 'Ago/2026', 'Set/2026', 'Out/2026', 'Nov/2026', 'Dez/2026'],
                ['Escavadeira', 1, 2, 3, 3, 3, 3, 3, 2, 2, 2, 1, 0],
                ['Caminhão 14m³', 5, 7, 12, 12, 12, 12, 10, 7, 5, 5, 3, 0],
                ['Trator', 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0],
                ['Retroescavadeira', 1, 1, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                ['Rolo Compactador', 0, 1, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0],
                ['Motoniveladora', 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0]
            ]);
            XLSX.utils.book_append_sheet(wb, ws, 'Equipamentos');
            XLSX.writeFile(wb, 'modelo_equipamentos_anual.xlsx');
        }

        function processarArquivo(file) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if (json.length < 2) { showToast('Arquivo vazio ou formato inválido', 'error'); return; }
                    
                    const cabecalho = json[0];
                    const colunasMeses = cabecalho.slice(1).filter(m => m);
                    
                    dadosExcel = {};
                    for (let i = 1; i < json.length; i++) {
                        const linha = json[i];
                        if (!linha[0]) continue;
                        
                        const nomeEquip = String(linha[0]).trim();
                        const equipId = nomeEquip.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                        
                        colunasMeses.forEach((mesColuna, idx) => {
                            if (!mesColuna) return;
                            const mesKey = converterMesParaKey(String(mesColuna));
                            if (!mesKey) return;
                            
                            if (!dadosExcel[mesKey]) dadosExcel[mesKey] = {};
                            dadosExcel[mesKey][equipId] = { nome: nomeEquip, previsto: parseInt(linha[idx + 1]) || 0 };
                        });
                    }
                    
                    const totalMeses = Object.keys(dadosExcel).length;
                    if (totalMeses === 0) { showToast('Nenhum mês válido encontrado', 'error'); return; }
                    
                    mostrarPreview(colunasMeses, json.slice(1));
                    showToast(`${json.length - 1} equipamentos em ${totalMeses} meses carregados`, 'success');
                    
                } catch (error) { showToast('Erro ao ler arquivo', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function converterMesParaKey(mesStr) {
            let str = String(mesStr).trim();
            
            if (/^\d+$/.test(str)) {
                const num = parseInt(str);
                if (num > 40000) {
                    const excelEpoch = new Date(1900, 0, 1);
                    const data = new Date(excelEpoch.getTime() + (num - 2) * 24 * 60 * 60 * 1000);
                    const mes = String(data.getMonth() + 1).padStart(2, '0');
                    const ano = data.getFullYear();
                    return `${mes}-${ano}`;
                }
            }
            
            if (typeof mesStr === 'number') {
                const excelEpoch = new Date(1900, 0, 1);
                const data = new Date(excelEpoch.getTime() + (mesStr - 2) * 24 * 60 * 60 * 1000);
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const ano = data.getFullYear();
                return `${mes}-${ano}`;
            }
            
            if (mesStr instanceof Date) {
                const mes = String(mesStr.getMonth() + 1).padStart(2, '0');
                const ano = mesStr.getFullYear();
                return `${mes}-${ano}`;
            }
            
            const formatoISO = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
            if (formatoISO) {
                return `${formatoISO[2]}-${formatoISO[1]}`;
            }
            
            const formatoDataBR = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
            if (formatoDataBR) {
                return `${formatoDataBR[2]}-${formatoDataBR[3]}`;
            }
            
            const mesesMap = { 
                'jan': '01', 'janeiro': '01', 'jan.': '01',
                'fev': '02', 'fevereiro': '02', 'fev.': '02',
                'mar': '03', 'março': '03', 'marco': '03', 'mar.': '03',
                'abr': '04', 'abril': '04', 'abr.': '04',
                'mai': '05', 'maio': '05', 'mai.': '05',
                'jun': '06', 'junho': '06', 'jun.': '06',
                'jul': '07', 'julho': '07', 'jul.': '07',
                'ago': '08', 'agosto': '08', 'ago.': '08',
                'set': '09', 'setembro': '09', 'set.': '09',
                'out': '10', 'outubro': '10', 'out.': '10',
                'nov': '11', 'novembro': '11', 'nov.': '11',
                'dez': '12', 'dezembro': '12', 'dez.': '12'
            };
            
            const formatoNumerico = str.match(/^(\d{2})[\/\-](\d{4})$/);
            if (formatoNumerico) {
                return `${formatoNumerico[1]}-${formatoNumerico[2]}`;
            }
            
            const partes = str.toLowerCase().split(/[\/\s\-]+/);
            const mesEncontrado = partes.find(p => mesesMap[p.replace(/[^a-z.]/g, '')]);
            const anoEncontrado = partes.find(p => /^\d{4}$/.test(p));
            
            if (mesEncontrado && anoEncontrado) {
                return `${mesesMap[mesEncontrado.replace(/[^a-z.]/g, '')]}-${anoEncontrado}`;
            }
            
            return null;
        }

        function mostrarPreview(colunasMeses, linhas) {
            const thead = document.getElementById('previewThead');
            const tbody = document.getElementById('previewTbody');
            
            let htmlHead = '<tr><th>Equipamento</th>';
            colunasMeses.forEach(mes => {
                let displayMes = mes;
                
                if (typeof mes === 'number') {
                    const excelEpoch = new Date(1900, 0, 1);
                    const data = new Date(excelEpoch.getTime() + (mes - 2) * 24 * 60 * 60 * 1000);
                    displayMes = data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                }
                else if (mes instanceof Date) {
                    displayMes = mes.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                }
                
                htmlHead += `<th style="text-align:center; min-width: 80px;">${displayMes}</th>`;
            });
            htmlHead += '</tr>';
            thead.innerHTML = htmlHead;
            
            let htmlBody = '';
            linhas.slice(0, 10).forEach(linha => {
                if (!linha[0]) return;
                htmlBody += `<tr><td>${linha[0]}</td>`;
                for (let i = 1; i <= colunasMeses.length; i++) {
                    htmlBody += `<td style="text-align:center">${linha[i] !== undefined ? linha[i] : '-'}</td>`;
                }
                htmlBody += '</tr>';
            });
            
            if (linhas.length > 10) {
                htmlBody += `<tr><td colspan="${colunasMeses.length + 1}" style="text-align:center;color:var(--cinza-medio)">... e mais ${linhas.length - 10} equipamentos</td></tr>`;
            }
            
            tbody.innerHTML = htmlBody;
            document.getElementById('previewContainer').style.display = 'block';
        }

        async function salvarEquipamentosExcel() {
            if (!obraSelecionada || Object.keys(dadosExcel).length === 0) { showToast('Nenhum dado para salvar', 'error'); return; }

            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
            btn.disabled = true;

            try {
                let salvos = 0;
                for (const mesKey of Object.keys(dadosExcel)) {
                    const equipamentos = {};
                    Object.entries(dadosExcel[mesKey]).forEach(([id, eq]) => {
                        if (eq.previsto > 0) equipamentos[id] = eq;
                    });
                    
                    if (Object.keys(equipamentos).length > 0) {
                        await window.dbSet(window.dbRef(window.db, `obras/${obraSelecionada}/contrato/${mesKey}`), equipamentos);
                        salvos++;
                    }
                }

                showToast(`${salvos} meses salvos com sucesso!`, 'success');
                limparUpload();
                carregarEquipamentosExistentes();
            } catch (error) { showToast('Erro ao salvar', 'error'); }
            finally { btn.innerHTML = originalHTML; btn.disabled = false; }
        }

        function limparUpload() {
            dadosExcel = {};
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('previewThead').innerHTML = '';
            document.getElementById('previewTbody').innerHTML = '';
        }

        async function carregarEquipamentosExistentes() {
            if (!obraSelecionada) return;
            
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, `obras/${obraSelecionada}/contrato`));
                const container = document.getElementById('listaExistente');
                const tbody = document.getElementById('tbodyExistente');
                
                if (snapshot.exists()) {
                    const contratos = snapshot.val();
                    let html = '';
                    let total = 0;
                    
                    Object.keys(contratos).sort().forEach(mesKey => {
                        const [mes, ano] = mesKey.split('-');
                        const data = new Date(ano, mes - 1);
                        const mesNome = data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
                        
                        Object.entries(contratos[mesKey]).forEach(([id, eq]) => {
                            total++;
                            html += `<tr><td>${mesNome}</td><td>${eq.nome}</td><td style="text-align:center">${eq.previsto}</td><td style="text-align:center"><button class="btn-icon btn-danger" style="width:30px;height:30px" onclick="excluirEquipamentoMes('${mesKey}','${id}')" title="Excluir"><i class="fas fa-trash" style="font-size:0.8rem"></i></button></td></tr>`;
                        });
                    });
                    
                    tbody.innerHTML = html;
                    container.querySelector('h4').innerHTML = `<i class="fas fa-list"></i> ${total} equipamentos cadastrados`;
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            } catch (error) { console.error(error); }
        }

        async function excluirEquipamentoMes(mesKey, equipId) {
            if (!confirm('Deseja excluir?')) return;
            try {
                await window.dbRemove(window.dbRef(window.db, `obras/${obraSelecionada}/contrato/${mesKey}/${equipId}`));
                showToast('Excluído', 'success');
                carregarEquipamentosExistentes();
            } catch (error) { showToast('Erro', 'error'); }
        }

        // ==================== FISCAIS ====================
        async function carregarFiscais() {
            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, 'fiscais'));
                if (snapshot.exists()) {
                    fiscais = snapshot.val();
                    renderFiscaisList();
                } else {
                    document.getElementById('fiscaisList').innerHTML = '<div class="empty-state"><i class="fas fa-users-slash"></i><p>Nenhum fiscal cadastrado</p></div>';
                }
            } catch (error) { showToast('Erro ao carregar fiscais', 'error'); }
        }

        function renderFiscaisList() {
            const container = document.getElementById('fiscaisList');
            let html = '';
            Object.keys(fiscais).forEach(key => {
                const fiscal = fiscais[key];
                const iniciais = fiscal.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                html += `
                    <div class="fiscal-item">
                        <div class="fiscal-info">
                            <div class="fiscal-avatar">${iniciais}</div>
                            <div>
                                <div style="font-weight:700; font-size: 1.1rem;">${fiscal.nome}</div>
                                <div style="font-size:0.9rem;color:var(--cinza-medio)">${fiscal.email || 'Sem e-mail'}</div>
                                <span class="fiscal-status ${fiscal.ativo !== false ? 'ativo' : 'inativo'}">${fiscal.ativo !== false ? 'Ativo' : 'Inativo'}</span>
                            </div>
                        </div>
                        <div class="obra-actions">
                            <button class="btn-icon btn-warning" onclick="toggleFiscal('${key}')" title="${fiscal.ativo !== false ? 'Desativar' : 'Ativar'}"><i class="fas ${fiscal.ativo !== false ? 'fa-pause' : 'fa-play'}"></i></button>
                            <button class="btn-icon btn-danger" onclick="excluirFiscal('${key}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
            });
            container.innerHTML = html;
        }

        async function criarFiscal() {
            const nome = document.getElementById('novoFiscalNome').value.trim();
            const email = document.getElementById('novoFiscalEmail').value.trim();
            if (!nome) { showToast('Digite o nome', 'error'); return; }

            try {
                const fiscalId = nome.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                await window.dbSet(window.dbRef(window.db, `fiscais/${fiscalId}`), { nome, email, ativo: true, criadoEm: new Date().toISOString() });
                showToast('Fiscal cadastrado!', 'success');
                document.getElementById('novoFiscalNome').value = '';
                document.getElementById('novoFiscalEmail').value = '';
                carregarFiscais();
                carregarFiscaisParaNovaObra();
            } catch (error) { showToast('Erro ao cadastrar', 'error'); }
        }

        async function toggleFiscal(fiscalId) {
            const novoStatus = fiscais[fiscalId].ativo === false ? true : false;
            try {
                await window.dbSet(window.dbRef(window.db, `fiscais/${fiscalId}/ativo`), novoStatus);
                showToast(`Fiscal ${novoStatus ? 'ativado' : 'desativado'}`, 'success');
                carregarFiscais();
                carregarFiscaisParaNovaObra();
            } catch (error) { showToast('Erro', 'error'); }
        }

        function excluirFiscal(fiscalId) {
            if (!confirm('Deseja excluir?')) return;
            window.dbRemove(window.dbRef(window.db, `fiscais/${fiscalId}`)).then(() => { showToast('Excluído', 'success'); carregarFiscais(); carregarFiscaisParaNovaObra(); }).catch(() => showToast('Erro', 'error'));
        }

        // ==================== RDCs ====================
        async function carregarRDCs() {
            const obraId = document.getElementById('filtroObraRDC').value;
            const periodo = document.getElementById('filtroPeriodoRDC').value;
            
            if (!obraId) {
                document.getElementById('rdcListContainer').innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-list"></i><p>Selecione uma obra</p></div>';
                return;
            }

            const container = document.getElementById('rdcListContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Carregando...</p></div>';

            try {
                const snapshot = await window.dbGet(window.dbRef(window.db, `obras/${obraId}/relatorios`));
                if (!snapshot.exists()) {
                    container.innerHTML = '<div class="empty-state"><i class="fas fa-clipboard-check"></i><p>Nenhum RDC encontrado</p></div>';
                    return;
                }

                let rdcs = Object.entries(snapshot.val()).map(([id, r]) => ({ id, ...r }));
                const hoje = new Date();
                
                rdcs = rdcs.filter(r => {
                    const dataRDC = new Date(r.dataKey || r.data);
                    switch(periodo) {
                        case 'mes-atual': return dataRDC.getMonth() === hoje.getMonth() && dataRDC.getFullYear() === hoje.getFullYear();
                        case 'ultimos-30': return dataRDC >= new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
                        case 'ultimos-7': return dataRDC >= new Date(hoje.getTime() - (7 * 24 * 60 * 60 * 1000));
                        default: return true;
                    }
                }).sort((a, b) => new Date(b.dataKey || b.data) - new Date(a.dataKey || a.data));

                renderRDCList(rdcs, obraId, periodo);
            } catch (error) { container.innerHTML = '<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>Erro ao carregar</p></div>'; }
        }

        function renderRDCList(rdcs, obraId, periodo) {
            const container = document.getElementById('rdcListContainer');
            if (rdcs.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-search"></i><p>Nenhum RDC no período</p></div>';
                return;
            }

            rdcsParaExportar = rdcs;
            obraExportacao = obraId;
            const periodoNomes = { 'todos': 'Todos', 'mes-atual': 'Mês atual', 'ultimos-30': 'Últimos 30 dias', 'ultimos-7': 'Últimos 7 dias' };

            let html = `
                <div class="export-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="font-weight: 700; margin-bottom: 0.5rem;"><i class="fas fa-chart-bar" style="margin-right: 10px;"></i> Resumo</h3>
                            <p style="font-size: 1.1rem;">${rdcs.length} RDC(s) | Período: ${periodoNomes[periodo]}</p>
                        </div>
                        <button class="btn" onclick="abrirModalExportar()" style="background: white; color: var(--verde-vale); box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                            <i class="fas fa-file-excel"></i> 
                            Exportar Excel
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 1.5rem; font-weight: 700; color: var(--cinza-medio); font-size: 1.1rem;">Lista de RDCs:</div>`;

            rdcs.forEach(rdc => {
                const qtdEquip = rdc.dados?.equipamentos ? Object.keys(rdc.dados.equipamentos).length : 0;
                const dataFormatada = formatarDataBR(rdc.dataKey || rdc.data);
                
                html += `
                    <div class="rdc-item">
                        <div class="rdc-info">
                            <h3><i class="fas fa-file-alt" style="color: var(--azul-vale); margin-right: 0.5rem;"></i>RDC ${rdc.numero || '---'}</h3>
                            <p><i class="fas fa-calendar"></i> ${dataFormatada} | <i class="fas fa-user"></i> ${rdc.fiscalNome || rdc.fiscal} | <i class="fas fa-tools"></i> ${qtdEquip} equip(s)</p>
                            ${rdc.dados?.clima?.condicao ? `<p style="margin-top: 0.3rem;"><i class="fas fa-cloud-sun"></i> ${rdc.dados.clima.condicao} | <i class="fas fa-tint"></i> ${rdc.dados.clima.pluviometro || 0}mm</p>` : ''}
                        </div>
                        <div class="obra-actions">
                            <span class="status-badge status-${rdc.status || 'enviado'}" style="margin-right: 0.5rem;">${rdc.status || 'enviado'}</span>
                            <button class="btn-icon btn-success" onclick="verDetalhesRDC('${rdc.id}')" title="Ver"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>`;
            });

            container.innerHTML = html;
        }

        function abrirModalExportar() {
            const obra = obras[obraExportacao];
            const periodo = document.getElementById('filtroPeriodoRDC').value;
            const periodoNomes = { 'todos': 'Todos os RDCs', 'mes-atual': 'Mês atual', 'ultimos-30': 'Últimos 30 dias', 'ultimos-7': 'Últimos 7 dias' };

            document.getElementById('exportObraNome').value = obra.nome;
            document.getElementById('exportPeriodoNome').value = periodoNomes[periodo];
            document.getElementById('exportQuantidade').value = `${rdcsParaExportar.length} RDC(s)`;
            document.getElementById('modalExportar').classList.add('active');
        }

        function fecharModalExportar() { document.getElementById('modalExportar').classList.remove('active'); }

        async function confirmarExportacao() {
            const btn = event.target;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            btn.disabled = true;

            try {
                const wb = XLSX.utils.book_new();
                
                const geralData = rdcsParaExportar.map(rdc => ({
                    'RDC': rdc.numero || '-',
                    'Data': formatarDataBR(rdc.dataKey || rdc.data),
                    'Fiscal': rdc.fiscalNome || rdc.fiscal,
                    'Status': rdc.status || 'enviado',
                    'Condição Climática': rdc.dados?.clima?.condicao || '-',
                    'Pluviômetro (mm)': rdc.dados?.clima?.pluviometro || 0,
                    'Qtd Equipamentos': rdc.dados?.equipamentos ? Object.keys(rdc.dados.equipamentos).length : 0,
                    'Atividades': rdc.dados?.atividades?.descricao || '-',
                    'Comentários': rdc.dados?.atividades?.comentarios || '-'
                }));
                
                const wsGeral = XLSX.utils.json_to_sheet(geralData);
                wsGeral['!cols'] = [{wch:10}, {wch:12}, {wch:20}, {wch:12}, {wch:18}, {wch:15}, {wch:18}, {wch:40}, {wch:40}];
                XLSX.utils.book_append_sheet(wb, wsGeral, "Geral");

                const equipData = [];
                rdcsParaExportar.forEach(rdc => {
                    if (rdc.dados?.equipamentos) {
                        Object.entries(rdc.dados.equipamentos).forEach(([id, eq]) => {
                            equipData.push({
                                'RDC': rdc.numero || '-',
                                'Data': formatarDataBR(rdc.dataKey || rdc.data),
                                'Fiscal': rdc.fiscalNome || rdc.fiscal,
                                'Equipamento': eq.nome || id,
                                'Previsto': eq.previsto || '-',
                                'Real': eq.real !== undefined ? eq.real : '-',
                                'Manutenção': eq.manutencao || 0,
                                'Observações': eq.obs || '-'
                            });
                        });
                    }
                });
                
                if (equipData.length > 0) {
                    const wsEquip = XLSX.utils.json_to_sheet(equipData);
                    wsEquip['!cols'] = [{wch:10}, {wch:12}, {wch:20}, {wch:25}, {wch:12}, {wch:10}, {wch:12}, {wch:30}];
                    XLSX.utils.book_append_sheet(wb, wsEquip, "Equipamentos");
                }

                XLSX.writeFile(wb, `RDCs_${obras[obraExportacao].nome.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Excel gerado com sucesso!', 'success');
                fecharModalExportar();
            } catch (error) {
                showToast('Erro ao gerar Excel', 'error');
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        function verDetalhesRDC(rdcId) {
            const obraId = obraExportacao;
            window.open(`ver-rdc.html?obra=${obraId}&rdc=${rdcId}`, '_blank');
        }

        function editarObra(id) { showToast('Função em desenvolvimento', 'error'); }
        
        function excluirObra(id) {
            if (!confirm(`Excluir ${obras[id].nome}?`)) return;
            window.dbRemove(window.dbRef(window.db, `obras/${id}`)).then(() => { showToast('Obra excluída', 'success'); carregarObras(); document.getElementById('equipamentosEditor').style.display = 'none'; }).catch(() => showToast('Erro', 'error'));
        }

        document.getElementById('modalExportar').addEventListener('click', (e) => { if (e.target.id === 'modalExportar') fecharModalExportar(); });
    </script>
</body>
</html>
