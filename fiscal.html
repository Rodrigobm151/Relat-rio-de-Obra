<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>RDC 1.2</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>

:root{
--azul:#3CB5E5;
--verde:#007E79;
--cinza:#777;
--fundo:#f5f7fa;
}

*{box-sizing:border-box;font-family:Inter}

body{
margin:0;
background:var(--fundo);
}

header{
background:var(--azul);
color:#fff;
padding:15px;
display:flex;
justify-content:space-between;
align-items:center;
}

.container{
max-width:900px;
margin:auto;
padding:15px;
}

/* Cards */

.card{
background:#fff;
border-radius:12px;
padding:15px;
margin-bottom:12px;
box-shadow:0 2px 6px rgba(0,0,0,.08);
}

.obra-item{
padding:15px;
border-left:4px solid var(--azul);
margin-bottom:10px;
cursor:pointer;
}

.obra-item:hover{
background:#f0f9ff;
}

/* Equip */

.equip-item{
border:1px solid #ddd;
border-radius:10px;
padding:12px;
margin-bottom:10px;
}

.equip-header{
display:flex;
justify-content:space-between;
font-weight:600;
}

.equip-detail{
display:none;
margin-top:10px;
}

.equip-detail.open{
display:block;
}

.input{
width:100%;
padding:6px;
font-size:18px;
text-align:center;
border:1px solid var(--azul);
border-radius:6px;
}

.btn{
background:var(--azul);
color:#fff;
border:none;
padding:8px 15px;
border-radius:8px;
cursor:pointer;
}

.btn-sec{
background:#ddd;
color:#333;
}

.toast{
position:fixed;
top:20px;
left:50%;
transform:translateX(-50%);
background:#333;
color:#fff;
padding:10px 20px;
border-radius:20px;
display:none;
}

</style>
</head>

<body>

<header>
<div>
<b id="titulo">Minhas Obras</b><br>
<small id="subtitulo"></small>
</div>

<button class="btn-sec btn" onclick="sair()">Sair</button>
</header>

<div class="container">

<!-- OBRAS -->

<div id="obrasPanel"></div>

<!-- RDCs -->

<div id="rdcPanel" style="display:none">

<div class="card">
<button class="btn" onclick="novoRDC()">+ Novo RDC</button>
</div>

<div id="rdcList"></div>

</div>

<!-- FORM -->

<div id="formPanel" style="display:none">

<div class="card">

<b id="rdcTitulo"></b><br>
<small id="rdcData"></small>

</div>

<div class="card">

<label>Clima</label>

<select id="clima" class="input">

<option>Bom</option>
<option>Nublado</option>
<option>Chuva Leve</option>
<option>Chuva Forte</option>

</select>

</div>

<div class="card">

<label>Atividades</label>

<textarea id="atividades" class="input"></textarea>

</div>

<div class="card">

<b>Equipamentos (mês atual)</b>

<div id="equipContainer"></div>

</div>

<div class="card">

<button class="btn" onclick="enviar()">Enviar RDC</button>
<button class="btn-sec btn" onclick="voltar()">Voltar</button>

</div>

</div>

</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const config = {
apiKey: "AIzaSyDm7jQbxnJ2aq6Hf-e3ufkoMi2yc6PjIgE",
authDomain: "relatorio-obra-geotecnia.firebaseapp.com",
databaseURL: "https://relatorio-obra-geotecnia-default-rtdb.firebaseio.com",
projectId: "relatorio-obra-geotecnia",
storageBucket: "relatorio-obra-geotecnia.appspot.com",
messagingSenderId: "765646735604",
appId: "1:765646735604:web:59424d5353813939e976a1"
};

const app = initializeApp(config);
const db = getDatabase(app);

window.db=db;
window.ref=ref;
window.get=get;
window.push=push;

init();

</script>

<script>

let fiscal = localStorage.getItem("fiscal") || "Fiscal";
let obraAtual=null;
let rdcAtual=null;
let equipamentos=[];

function toast(msg){

const t=document.getElementById("toast");
t.innerText=msg;
t.style.display="block";

setTimeout(()=>t.style.display="none",3000);

}

function getMesAtual(){

const d=new Date();

const m=String(d.getMonth()+1).padStart(2,"0");
const a=d.getFullYear();

return `${m}-${a}`;

}

async function init(){

document.getElementById("subtitulo").innerText="Olá, "+fiscal;

carregarObras();

}

/* OBRAS */

async function carregarObras(){

const div=document.getElementById("obrasPanel");
div.innerHTML="Carregando...";

const snap=await get(ref(db,"obras"));

let html="";

if(snap.exists()){

snap.forEach(o=>{

html+=`

<div class="obra-item" onclick="abrirObra('${o.key}','${o.val().nome}')">

<b>${o.val().nome}</b><br>
<small>Abrir relatórios</small>

</div>

`;

});

}

div.innerHTML=html || "Nenhuma obra";

}

function abrirObra(id,nome){

obraAtual={id,nome};

document.getElementById("titulo").innerText=nome;

document.getElementById("obrasPanel").style.display="none";
document.getElementById("rdcPanel").style.display="block";

carregarRDCs();

}

/* RDC */

async function carregarRDCs(){

const div=document.getElementById("rdcList");

div.innerHTML="Buscando...";

const snap=await get(ref(db,`obras/${obraAtual.id}/relatorios`));

let html="";

if(snap.exists()){

snap.forEach(r=>{

html+=`

<div class="card">

<b>RDC #${r.val().numero}</b><br>
<small>${r.val().data}</small>

</div>

`;

});

}

div.innerHTML=html||"Nenhum RDC";

}

/* NOVO */

async function novoRDC(){

const d=new Date();

rdcAtual={
numero:Math.floor(Math.random()*900+100),
data:d.toLocaleDateString("pt-BR"),
mes:getMesAtual(),
dados:{equipamentos:{}}
};

document.getElementById("rdcTitulo").innerText="RDC #"+rdcAtual.numero;
document.getElementById("rdcData").innerText=rdcAtual.data+" ("+rdcAtual.mes+")";

document.getElementById("rdcPanel").style.display="none";
document.getElementById("formPanel").style.display="block";

await carregarEquip();

}

/* EQUIP */

async function carregarEquip(){

const div=document.getElementById("equipContainer");

div.innerHTML="Carregando...";

const mes=rdcAtual.mes;

const snap=await get(ref(db,`obras/${obraAtual.id}/contrato/${mes}`));

equipamentos=[];

if(!snap.exists()){

div.innerHTML="Nenhum planejamento para "+mes;
return;

}

snap.forEach(e=>{

equipamentos.push({
id:e.key,
...e.val()
});

});

renderEquip();

}

function renderEquip(){

const div=document.getElementById("equipContainer");

let html="";

equipamentos.forEach((e,i)=>{

const edit=rdcAtual.dados.equipamentos[e.id];
const real=edit?edit.real:e.previsto;

html+=`

<div class="equip-item">

<div class="equip-header" onclick="toggle(${i})">

<span>${e.nome}</span>
<span>${real} / ${e.previsto}</span>

</div>

<div class="equip-detail" id="det-${i}">

<input class="input" id="inp-${i}" type="number" value="${real}">

<button class="btn" onclick="salvarEquip('${e.id}',${i})">Confirmar</button>

</div>

</div>

`;

});

div.innerHTML=html;

}

function toggle(i){

document.getElementById("det-"+i).classList.toggle("open");

}

function salvarEquip(id,i){

const v=parseInt(document.getElementById("inp-"+i).value)||0;

rdcAtual.dados.equipamentos[id]={real:v};

toast("Atualizado");

renderEquip();

}

/* ENVIAR */

async function enviar(){

try{

rdcAtual.dados.clima=document.getElementById("clima").value;
rdcAtual.dados.atividades=document.getElementById("atividades").value;
rdcAtual.fiscal=fiscal;

await push(ref(db,`obras/${obraAtual.id}/relatorios`),rdcAtual);

toast("RDC enviado");

voltar();

}catch(e){

toast("Erro");

console.error(e);

}

}

/* VOLTAR */

function voltar(){

document.getElementById("formPanel").style.display="none";
document.getElementById("rdcPanel").style.display="block";

carregarRDCs();

}

function sair(){

localStorage.clear();
location.reload();

}

</script>

</body>
</html>
